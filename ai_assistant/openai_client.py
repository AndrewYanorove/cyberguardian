import os
import openai
from flask import current_app

class AIClient:
    def __init__(self):
        self.api_key = os.getenv('OPENAI_API_KEY')
        self.client = None
        if self.api_key and self.api_key != 'your-openai-api-key-here':
            openai.api_key = self.api_key
            self.client = openai
        else:
            print("‚ö†Ô∏è OpenAI API –∫–ª—é—á –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–µ–º–æ-—Ä–µ–∂–∏–º.")
    
    def get_response(self, message):
        """–ü–æ–ª—É—á–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞ –æ—Ç –ò–ò –∏–ª–∏ –¥–µ–º–æ-–æ—Ç–≤–µ—Ç–æ–≤"""
        try:
            # –î–µ–º–æ-—Ä–µ–∂–∏–º –µ—Å–ª–∏ API –∫–ª—é—á –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω
            if not self.client:
                return self.get_demo_response(message)
            
            # –†–µ–∞–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å –∫ OpenAI
            response = self.client.ChatCompletion.create(
                model="gpt-3.5-turbo",
                messages=[
                    {
                        "role": "system", 
                        "content": """–¢—ã —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –∫–∏–±–µ—Ä–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏. –û—Ç–≤–µ—á–∞–π –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã —á–µ—Ç–∫–æ, –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ, 
                        –Ω–æ –¥–æ—Å—Ç—É–ø–Ω—ã–º —è–∑—ã–∫–æ–º. –î–∞–≤–∞–π –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Å–æ–≤–µ—Ç—ã –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏. 
                        –ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å –Ω–µ –ø–æ —Ç–µ–º–µ, –≤–µ–∂–ª–∏–≤–æ –æ—Ç–∫–ª–æ–Ω–∏ –æ—Ç–≤–µ—Ç."""
                    },
                    {"role": "user", "content": message}
                ],
                max_tokens=500,
                temperature=0.7
            )
            
            return response.choices[0].message['content'].strip()
            
        except Exception as e:
            print(f"–û—à–∏–±–∫–∞ OpenAI: {e}")
            return self.get_demo_response(message)
    
    def get_demo_response(self, message):
        """–î–µ–º–æ-–æ—Ç–≤–µ—Ç—ã –¥–ª—è –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏"""
        demo_responses = {
            "–ø—Ä–∏–≤–µ—Ç": "–ü—Ä–∏–≤–µ—Ç! –Ø –≤–∞—à –ò–ò-–ø–æ–º–æ—â–Ω–∏–∫ –ø–æ –∫–∏–±–µ—Ä–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏. –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?",
            "–∫–∞–∫ —Å–æ–∑–¥–∞—Ç—å –Ω–∞–¥–µ–∂–Ω—ã–π –ø–∞—Ä–æ–ª—å": "üí° –î–ª—è –Ω–∞–¥–µ–∂–Ω–æ–≥–æ –ø–∞—Ä–æ–ª—è:\n‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ 12+ —Å–∏–º–≤–æ–ª–æ–≤\n‚Ä¢ –ö–æ–º–±–∏–Ω–∏—Ä—É–π—Ç–µ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã, —Å–ø–µ—Ü—Å–∏–º–≤–æ–ª—ã\n‚Ä¢ –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ª–∏—á–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é\n‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ä–∞–∑–Ω—ã–µ –ø–∞—Ä–æ–ª–∏ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤\n‚Ä¢ –†–∞—Å—Å–º–æ—Ç—Ä–∏—Ç–µ –º–µ–Ω–µ–¥–∂–µ—Ä –ø–∞—Ä–æ–ª–µ–π",
            "—á—Ç–æ —Ç–∞–∫–æ–µ —Ñ–∏—à–∏–Ω–≥": "üé£ –§–∏—à–∏–Ω–≥ - —ç—Ç–æ –º–æ—à–µ–Ω–Ω–∏—á–µ—Å–∫–∏–µ —Ä–∞—Å—Å—ã–ª–∫–∏, –º–∞—Å–∫–∏—Ä—É—é—â–∏–µ—Å—è –ø–æ–¥ –ª–µ–≥–∏—Ç–∏–º–Ω—ã–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏. \n–ü—Ä–∏–∑–Ω–∞–∫–∏ —Ñ–∏—à–∏–Ω–≥–∞:\n‚Ä¢ –°—Ä–æ—á–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –¥–µ–π—Å—Ç–≤–∏–π\n‚Ä¢ –ü–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã–µ —Å—Å—ã–ª–∫–∏\n‚Ä¢ –ì—Ä–∞–º–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏\n‚Ä¢ –ù–µ–∑–Ω–∞–∫–æ–º—ã–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª–∏",
            "–∫–∞–∫ –∑–∞—â–∏—Ç–∏—Ç—å wifi": "üì° –ó–∞—â–∏—Ç–∞ Wi-Fi:\n‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ WPA3 —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ\n‚Ä¢ –°–º–µ–Ω–∏—Ç–µ –ø–∞—Ä–æ–ª—å —Ä–æ—É—Ç–µ—Ä–∞\n‚Ä¢ –û—Ç–∫–ª—é—á–∏—Ç–µ WPS\n‚Ä¢ –°–∫—Ä—ã—Ç–∏–µ SSID\n‚Ä¢ –†–µ–≥—É–ª—è—Ä–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—à–∏–≤–∫–∏",
            "—á—Ç–æ —Ç–∞–∫–æ–µ –¥–≤—É—Ö—Ñ–∞–∫—Ç–æ—Ä–Ω–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è": "üîê 2FA - —ç—Ç–æ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏:\n‚Ä¢ –ü–∞—Ä–æ–ª—å + –∫–æ–¥ –∏–∑ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è\n‚Ä¢ –ü–∞—Ä–æ–ª—å + SMS\n‚Ä¢ –ü–∞—Ä–æ–ª—å + –±–∏–æ–º–µ—Ç—Ä–∏—è\n–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–ª—è –≤—Å–µ—Ö –≤–∞–∂–Ω—ã—Ö –∞–∫–∫–∞—É–Ω—Ç–æ–≤!",
            "–∫–∞–∫–æ–π –∞–Ω—Ç–∏–≤–∏—Ä—É—Å –≤—ã–±—Ä–∞—Ç—å": "üõ°Ô∏è –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –∞–Ω—Ç–∏–≤–∏—Ä—É—Å–∞–º:\n‚Ä¢ –î–ª—è Windows: Windows Defender + –∑–¥—Ä–∞–≤—ã–π —Å–º—ã—Å–ª\n‚Ä¢ –ü–ª–∞—Ç–Ω—ã–µ: Kaspersky, ESET, Bitdefender\n‚Ä¢ –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–µ: Avast, AVG\n‚Ä¢ –ì–ª–∞–≤–Ω–æ–µ - —Ä–µ–≥—É–ª—è—Ä–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è!"
        }
        
        message_lower = message.lower()
        for key in demo_responses:
            if key in message_lower:
                return demo_responses[key]
        
        return "ü§ñ –í –¥–µ–º–æ-—Ä–µ–∂–∏–º–µ. –î–ª—è –ø–æ–ª–Ω–æ–≥–æ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞ –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ OPENAI_API_KEY –≤ .env —Ñ–∞–π–ª–µ.\n\n–ù–æ —è –º–æ–≥—É —Å–∫–∞–∑–∞—Ç—å: –¥–ª—è –∫–∏–±–µ—Ä–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –≤–∞–∂–Ω–æ:\n‚Ä¢ –†–µ–≥—É–ª—è—Ä–Ω–æ –æ–±–Ω–æ–≤–ª—è—Ç—å –ü–û\n‚Ä¢ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –Ω–∞–¥–µ–∂–Ω—ã–µ –ø–∞—Ä–æ–ª–∏\n‚Ä¢ –í–∫–ª—é—á–∞—Ç—å 2FA\n‚Ä¢ –û—Å—Ç–µ—Ä–µ–≥–∞—Ç—å—Å—è —Ñ–∏—à–∏–Ω–≥–∞\n‚Ä¢ –î–µ–ª–∞—Ç—å —Ä–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–ø–∏–∏"

# –ì–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä –∫–ª–∏–µ–Ω—Ç–∞
ai_client = AIClient()
