{% extends "base.html" %}

{% block title %}–°–∫–∞–Ω–µ—Ä —Å–µ—Ç–∏ - CyberGuardian{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="text-center mb-5">
                <h1 class="cyber-text glow-text mb-3">
                    <i class="bi bi-hdd-network me-2"></i>–°–∫–∞–Ω–µ—Ä —Å–µ—Ç–∏
                </h1>
                <p class="cyber-subtext lead">
                    –ê–Ω–∞–ª–∏–∑ —Å–µ—Ç–µ–≤–æ–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π
                </p>
            </div>

            <div class="scanner-card">
                <h4 class="cyber-text mb-4">üåê –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–µ—Ç–∏</h4>
                
                <div class="row mb-4">
                    <div class="col-md-8">
                        <label class="form-label cyber-text">–¶–µ–ª—å —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è:</label>
                        <input type="text" class="form-control cyber-input" id="targetInput" 
                               value="192.168.1.1" placeholder="IP –∞–¥—Ä–µ—Å –∏–ª–∏ –¥–æ–º–µ–Ω">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label cyber-text">–¢–∏–ø —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è:</label>
                        <select class="form-select cyber-input" id="scanType">
                            <option value="quick">–ë—ã—Å—Ç—Ä–æ–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</option>
                            <option value="full">–ü–æ–ª–Ω–æ–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</option>
                            <option value="ports">–¢–æ–ª—å–∫–æ –ø–æ—Ä—Ç—ã</option>
                        </select>
                    </div>
                </div>

                <button onclick="scanNetwork()" class="btn btn-cyber w-100 mb-4">
                    <i class="bi bi-radar me-2"></i>–ù–∞—á–∞—Ç—å —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
                </button>

                <div class="scan-animation" id="networkScanAnimation" style="display: none;">
                    <div class="cyber-loader mx-auto mb-3"></div>
                    <p class="cyber-text">–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–µ—Ç–∏...</p>
                    <div class="scan-progress">
                        <div class="progress-bar" id="networkScanProgress" style="width: 0%"></div>
                    </div>
                </div>

                <div class="scan-result" id="networkResult" style="display: none;">
                    <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∑–∞–≥—Ä—É–∑—è—Ç—Å—è —á–µ—Ä–µ–∑ JS -->
                </div>
            </div>

            <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è -->
            <div class="scanner-card mt-4" id="scanResults" style="display: none;">
                <h4 class="cyber-text mb-4">üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</h4>
                
                <div class="row mb-4">
                    <div class="col-md-4">
                        <div class="stat-item">
                            <h3 class="cyber-text" id="openPortsCount">0</h3>
                            <p class="cyber-subtext">–û—Ç–∫—Ä—ã—Ç—ã—Ö –ø–æ—Ä—Ç–æ–≤</p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="stat-item">
                            <h3 class="cyber-text" id="vulnsCount">0</h3>
                            <p class="cyber-subtext">–£—è–∑–≤–∏–º–æ—Å—Ç–µ–π</p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="stat-item">
                            <h3 class="cyber-text" id="securityScore">0%</h3>
                            <p class="cyber-subtext">–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å</p>
                        </div>
                    </div>
                </div>

                <h5 class="cyber-text mb-3">üîç –û—Ç–∫—Ä—ã—Ç—ã–µ –ø–æ—Ä—Ç—ã</h5>
                <div class="table-responsive">
                    <table class="table cyber-table">
                        <thead>
                            <tr>
                                <th>–ü–æ—Ä—Ç</th>
                                <th>–°–µ—Ä–≤–∏—Å</th>
                                <th>–°—Ç–∞—Ç—É—Å</th>
                                <th>–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å</th>
                            </tr>
                        </thead>
                        <tbody id="portsTable">
                            <!-- –ü–æ—Ä—Ç—ã –∑–∞–≥—Ä—É–∑—è—Ç—Å—è —á–µ—Ä–µ–∑ JS -->
                        </tbody>
                    </table>
                </div>

                <h5 class="cyber-text mb-3 mt-4">‚ö†Ô∏è –û–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã–µ —É—è–∑–≤–∏–º–æ—Å—Ç–∏</h5>
                <div id="vulnerabilitiesList">
                    <!-- –£—è–∑–≤–∏–º–æ—Å—Ç–∏ –∑–∞–≥—Ä—É–∑—è—Ç—Å—è —á–µ—Ä–µ–∑ JS -->
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–µ—Ç–∏
async function scanNetwork() {
    const target = document.getElementById('targetInput').value;
    const scanType = document.getElementById('scanType').value;
    
    if (!target) {
        alert('–í–≤–µ–¥–∏—Ç–µ —Ü–µ–ª—å –¥–ª—è —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è');
        return;
    }
    
    const animation = document.getElementById('networkScanAnimation');
    const result = document.getElementById('networkResult');
    const progress = document.getElementById('networkScanProgress');
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é
    animation.style.display = 'block';
    result.style.display = 'none';
    
    // –ê–Ω–∏–º–∞—Ü–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
    let width = 0;
    const interval = setInterval(() => {
        width += 2;
        progress.style.width = width + '%';
        if (width >= 100) clearInterval(interval);
    }, 100);
    
    try {
        const response = await fetch('/scanner/api/scan/network', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ 
                target: target,
                scan_type: scanType
            })
        });
        
        const scanResult = await response.json();
        displayNetworkResult(scanResult);
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Å–µ—Ç–∏:', error);
        animation.style.display = 'none';
        result.style.display = 'block';
        result.innerHTML = `
            <div class="alert alert-danger">
                <i class="bi bi-exclamation-triangle me-2"></i>
                –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏ —Å–µ—Ç–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.
            </div>
        `;
    }
}

// –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Å–µ—Ç–∏
function displayNetworkResult(result) {
    const animation = document.getElementById('networkScanAnimation');
    const resultDiv = document.getElementById('networkResult');
    const resultsDiv = document.getElementById('scanResults');
    
    animation.style.display = 'none';
    resultDiv.style.display = 'block';
    resultsDiv.style.display = 'block';
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    document.getElementById('openPortsCount').textContent = result.ports.filter(p => p.status === 'open').length;
    document.getElementById('vulnsCount').textContent = result.vulnerabilities.length;
    document.getElementById('securityScore').textContent = result.security_score + '%';
    
    // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ç–∞–±–ª–∏—Ü—É –ø–æ—Ä—Ç–æ–≤
    const portsTable = document.getElementById('portsTable');
    portsTable.innerHTML = result.ports.map(port => `
        <tr>
            <td><strong>${port.port}</strong></td>
            <td>${port.service}</td>
            <td>
                <span class="badge bg-${port.status === 'open' ? 'success' : 'secondary'}">
                    ${port.status === 'open' ? '–û—Ç–∫—Ä—ã—Ç' : '–ó–∞–∫—Ä—ã—Ç'}
                </span>
            </td>
            <td>
                <span class="badge bg-${port.security === 'critical' ? 'danger' : 
                                      port.security === 'high' ? 'warning' : 
                                      port.security === 'medium' ? 'info' : 'success'}">
                    ${port.security === 'critical' ? '–ö—Ä–∏—Ç–∏—á–Ω–æ' :
                      port.security === 'high' ? '–í—ã—Å–æ–∫–∞—è' :
                      port.security === 'medium' ? '–°—Ä–µ–¥–Ω—è—è' : '–ù–∏–∑–∫–∞—è'}
                </span>
            </td>
        </tr>
    `).join('');
    
    // –ó–∞–ø–æ–ª–Ω—è–µ–º —Å–ø–∏—Å–æ–∫ —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π
    const vulnsList = document.getElementById('vulnerabilitiesList');
    if (result.vulnerabilities.length > 0) {
        vulnsList.innerHTML = result.vulnerabilities.map(vuln => `
            <div class="alert alert-warning mb-2">
                <i class="bi bi-exclamation-triangle me-2"></i>
                <strong>${vuln}</strong>
            </div>
        `).join('');
    } else {
        vulnsList.innerHTML = `
            <div class="alert alert-success">
                <i class="bi bi-check-circle me-2"></i>
                –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ
            </div>
        `;
    }
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
    resultDiv.innerHTML = `
        <h5 class="cyber-text mb-3">
            <i class="bi bi-check-circle text-success me-2"></i>–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ
        </h5>
        
        <div class="security-meter mb-3">
            <div class="meter-fill" style="width: ${result.security_score}%; background: ${getSecurityColor(result.security_score)};"></div>
        </div>
        
        <h6 class="cyber-text mb-3">üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ —Å–µ—Ç–∏:</h6>
        <div class="row">
            ${result.recommendations.map(rec => `
                <div class="col-md-6 mb-2">
                    <i class="bi bi-arrow-right text-cyber-primary me-2"></i>
                    <span class="cyber-subtext">${rec}</span>
                </div>
            `).join('')}
        </div>
    `;
}

// –ü–æ–ª—É—á–µ–Ω–∏–µ —Ü–≤–µ—Ç–∞ –¥–ª—è —É—Ä–æ–≤–Ω—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
function getSecurityColor(score) {
    if (score >= 80) return '#20c997';
    if (score >= 70) return '#0dcaf0';
    if (score >= 50) return '#ffc107';
    if (score >= 30) return '#fd7e14';
    return '#dc3545';
}
</script>
{% endblock %}
