{% extends "base.html" %}

{% block title %}Мониторинг угроз - CyberGuardian{% endblock %}

{% block extra_css %}
<style>
/* Баннер разработки */
.dev-banner {
    background: linear-gradient(135deg, #ff6b35, #f7931e);
    border: 1px solid #ff8c42;
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 1.5rem;
    text-align: center;
}

.threat-card {
    border-left: 4px solid;
    transition: all 0.3s ease;
}

.threat-critical { border-left-color: #dc3545; background: rgba(220, 53, 69, 0.1); }
.threat-high { border-left-color: #fd7e14; background: rgba(253, 126, 20, 0.1); }
.threat-medium { border-left-color: #ffc107; background: rgba(255, 193, 7, 0.1); }
.threat-low { border-left-color: #20c997; background: rgba(32, 201, 151, 0.1); }

.live-feed {
    max-height: 400px;
    overflow-y: auto;
}

.feed-item {
    padding: 0.8rem;
    border-bottom: 1px solid var(--cyber-border);
    transition: background 0.3s ease;
}

.feed-item:hover {
    background: rgba(0, 255, 136, 0.05);
}

.threat-map-container {
    background: rgba(20, 20, 20, 0.8);
    border-radius: 10px;
    padding: 1rem;
    height: 500px;
    position: relative;
    overflow: hidden;
}

#threatMap3d {
    width: 100%;
    height: 100%;
    background: radial-gradient(circle at center, #0a0e17 0%, #050811 100%);
}

.map-controls {
    position: absolute;
    top: 1rem;
    right: 1rem;
    z-index: 100;
}

.control-btn {
    background: rgba(30, 30, 30, 0.8);
    border: 1px solid var(--cyber-primary);
    color: var(--cyber-primary);
    border-radius: 5px;
    padding: 0.5rem;
    margin-bottom: 0.5rem;
    cursor: pointer;
    transition: all 0.3s ease;
}

.control-btn:hover {
    background: var(--cyber-primary);
    color: black;
}

.threat-legend {
    position: absolute;
    bottom: 1rem;
    left: 1rem;
    background: rgba(20, 20, 20, 0.9);
    border: 1px solid var(--cyber-border);
    border-radius: 8px;
    padding: 1rem;
    z-index: 100;
}

.legend-item {
    display: flex;
    align-items: center;
    margin-bottom: 0.5rem;
}

.legend-color {
    width: 16px;
    height: 16px;
    border-radius: 50%;
    margin-right: 0.5rem;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin: 1.5rem 0;
}

.stat-card {
    background: rgba(30, 30, 30, 0.8);
    border: 1px solid var(--cyber-border);
    border-radius: 10px;
    padding: 1.5rem;
    text-align: center;
    transition: all 0.3s ease;
}

.stat-card:hover {
    transform: translateY(-5px);
    border-color: var(--cyber-primary);
}

.severity-badge {
    padding: 0.3rem 0.8rem;
    border-radius: 15px;
    font-size: 0.8rem;
    font-weight: bold;
}

.badge-critical { background: #dc3545; color: white; }
.badge-high { background: #fd7e14; color: white; }
.badge-medium { background: #ffc107; color: black; }
.badge-low { background: #20c997; color: white; }

.threat-tooltip {
    position: absolute;
    background: rgba(20, 20, 20, 0.95);
    border: 1px solid var(--cyber-primary);
    border-radius: 8px;
    padding: 1rem;
    color: white;
    font-size: 0.9rem;
    pointer-events: none;
    z-index: 1000;
    max-width: 300px;
    backdrop-filter: blur(10px);
}

/* Модальное окно для деталей угрозы */
.threat-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    z-index: 2000;
    backdrop-filter: blur(5px);
}

.modal-content {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(20, 20, 20, 0.95);
    border: 2px solid var(--cyber-primary);
    border-radius: 15px;
    padding: 2rem;
    max-width: 600px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
}

.modal-header {
    display: flex;
    justify-content: between;
    align-items: center;
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid var(--cyber-border);
}

.modal-close {
    background: none;
    border: none;
    color: var(--cyber-primary);
    font-size: 1.5rem;
    cursor: pointer;
    padding: 0;
}

.threat-details-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
    margin-bottom: 1.5rem;
}

.detail-item {
    margin-bottom: 1rem;
}

.detail-label {
    font-size: 0.8rem;
    color: var(--cyber-subtext);
    margin-bottom: 0.3rem;
}

.detail-value {
    font-size: 1rem;
    color: white;
}

.attack-list {
    margin-top: 1rem;
}

.attack-item {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 8px;
    padding: 0.8rem;
    margin-bottom: 0.8rem;
    border-left: 4px solid;
}

.attack-critical { border-left-color: #dc3545; }
.attack-high { border-left-color: #fd7e14; }
.attack-medium { border-left-color: #ffc107; }
.attack-low { border-left-color: #20c997; }

.pulse-effect {
    animation: threat-pulse 2s infinite;
}

@keyframes threat-pulse {
    0% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
    50% { transform: translate(-50%, -50%) scale(1.1); opacity: 0.8; }
    100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Баннер разработки -->
    <div class="dev-banner">
        <div class="d-flex align-items-center justify-content-center">
            <i class="bi bi-tools display-6 me-3"></i>
            <div>
                <h4 class="mb-1"><strong>Модуль в разработке</strong></h4>
                <p class="mb-0">В настоящее время отображаются симулированные данные для демонстрации функциональности.</p>
            </div>
        </div>
    </div>

    <!-- Заголовок -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="cyber-text glow-text mb-2">
                        <i class="bi bi-shield-exclamation me-2"></i>Мониторинг угроз
                    </h1>
                    <p class="cyber-subtext">Отслеживание киберугроз в реальном времени</p>
                </div>
                <div class="text-end">
                    <div class="cyber-badge bg-warning">
                        <i class="bi bi-tools me-1"></i>Режим разработки
                    </div>
                    <div class="cyber-subtext small mt-1" id="lastUpdate">Обновлено: --:--:--</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Статистика -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="stats-grid" id="statsGrid">
                <!-- Статистика загрузится через JS -->
            </div>
        </div>
    </div>

    <div class="row g-4">
        <!-- Активные угрозы -->
        <div class="col-lg-6">
            <div class="cyber-card p-4 h-100">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h4 class="cyber-text">
                        <i class="bi bi-activity me-2"></i>Активные угрозы
                    </h4>
                    <span class="cyber-badge bg-danger" id="activeThreatsCount">0</span>
                </div>
                <div id="activeThreatsList">
                    <!-- Угрозы загрузятся через JS -->
                </div>
            </div>
        </div>

        <!-- Живая лента -->
        <div class="col-lg-6">
            <div class="cyber-card p-4 h-100">
                <h4 class="cyber-text mb-3">
                    <i class="bi bi-rss me-2"></i>Живая лента событий
                </h4>
                <div class="live-feed" id="liveFeed">
                    <!-- События загрузятся через JS -->
                </div>
            </div>
        </div>

        <!-- Карта угроз 3D -->
        <div class="col-12">
            <div class="cyber-card p-4">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h4 class="cyber-text">
                        <i class="bi bi-globe me-2"></i>Интерактивная карта угроз 3D
                    </h4>
                    <div class="cyber-subtext">Кликайте на точки для детальной информации</div>
                </div>
                <div class="threat-map-container">
                    <div id="threatMap3d"></div>
                    <div class="map-controls">
                        <div class="control-btn" onclick="resetCamera()" title="Сбросить вид">
                            <i class="bi bi-arrow-clockwise"></i>
                        </div>
                        <div class="control-btn" onclick="toggleRotation()" title="Автовращение">
                            <i class="bi bi-play-circle" id="rotationIcon"></i>
                        </div>
                    </div>
                    <div class="threat-legend">
                        <h6 class="cyber-text mb-2">Уровень угроз:</h6>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #dc3545;"></div>
                            <small class="cyber-subtext">Критический</small>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #fd7e14;"></div>
                            <small class="cyber-subtext">Высокий</small>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #ffc107;"></div>
                            <small class="cyber-subtext">Средний</small>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #20c997;"></div>
                            <small class="cyber-subtext">Низкий</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Тултип для угроз -->
<div id="threatTooltip" class="threat-tooltip" style="display: none;"></div>

<!-- Модальное окно для деталей угрозы -->
<div id="threatModal" class="threat-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="cyber-text mb-0" id="modalTitle">Детали угрозы</h3>
            <button class="modal-close" onclick="closeThreatModal()">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>
        <div id="modalContent">
            <!-- Контент загружается через JS -->
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.min.js"></script>
<script>
// Глобальные переменные для Three.js
let scene, camera, renderer, controls, earth, threatSpheres = [];
let threatData = [];
let isRotating = true;

// Инициализация 3D карты
function init3DMap() {
    const container = document.getElementById('threatMap3d');
    
    // Сцена
    scene = new THREE.Scene();
    scene.background = new THREE.Color(0x0a0e17);
    
    // Камера
    camera = new THREE.PerspectiveCamera(45, container.clientWidth / container.clientHeight, 0.1, 1000);
    camera.position.z = 5;
    
    // Рендерер
    renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(container.clientWidth, container.clientHeight);
    renderer.setPixelRatio(window.devicePixelRatio);
    container.appendChild(renderer.domElement);
    
    // Элементы управления
    controls = new THREE.OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.dampingFactor = 0.05;
    controls.rotateSpeed = 0.5;
    controls.minDistance = 3;
    controls.maxDistance = 10;
    
    // Освещение
    const ambientLight = new THREE.AmbientLight(0x404040, 0.6);
    scene.add(ambientLight);
    
    const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
    directionalLight.position.set(5, 3, 5);
    scene.add(directionalLight);
    
    // Создание Земли
    createEarth();
    
    // Загрузка данных угроз
    loadThreatMapData();
    
    // Анимация
    animate();
    
    // Обработчик изменения размера
    window.addEventListener('resize', onWindowResize);
}

// Создание 3D Земли
function createEarth() {
    const geometry = new THREE.SphereGeometry(2, 64, 64);
    
    // Текстура Земли
    const textureLoader = new THREE.TextureLoader();
    const earthTexture = textureLoader.load('https://cdn.jsdelivr.net/npm/three-globe/example/img/earth-blue-marble.jpg');
    const bumpMap = textureLoader.load('https://cdn.jsdelivr.net/npm/three-globe/example/img/earth-topology.png');
    
    const material = new THREE.MeshPhongMaterial({
        map: earthTexture,
        bumpMap: bumpMap,
        bumpScale: 0.05,
        specular: new THREE.Color(0x333333),
        shininess: 5
    });
    
    earth = new THREE.Mesh(geometry, material);
    scene.add(earth);
    
    // Облака
    const cloudGeometry = new THREE.SphereGeometry(2.03, 64, 64);
    const cloudTexture = textureLoader.load('https://cdn.jsdelivr.net/npm/three-globe/example/img/earth-clouds.png');
    const cloudMaterial = new THREE.MeshPhongMaterial({
        map: cloudTexture,
        transparent: true,
        opacity: 0.4
    });
    
    const clouds = new THREE.Mesh(cloudGeometry, cloudMaterial);
    scene.add(clouds);
}

// Загрузка данных для карты угроз
function loadThreatMapData() {
    // Симулированные данные угроз по странам с детальной информацией
    const countriesData = [
        { 
            country: "США", 
            lat: 39.8283, 
            lng: -98.5795, 
            threats: 45, 
            severity: "critical", 
            types: ["DDoS атаки", "Фишинг кампании", "Вредоносное ПО"],
            recentAttacks: [
                { type: "DDoS", severity: "critical", time: "10:23", target: "Финансовый сектор", status: "Активна" },
                { type: "Фишинг", severity: "high", time: "09:15", target: "Корпоративная почта", status: "Блокирована" },
                { type: "Ransomware", severity: "critical", time: "08:42", target: "Медицинские учреждения", status: "Расследуется" }
            ],
            riskLevel: "Очень высокий",
            affectedSectors: ["Финансы", "Здравоохранение", "Энергетика"]
        },
        { 
            country: "Китай", 
            lat: 35.8617, 
            lng: 104.1954, 
            threats: 38, 
            severity: "high", 
            types: ["APT-атаки", "Кибершпионаж", "Промышленный шпионаж"],
            recentAttacks: [
                { type: "APT", severity: "high", time: "11:30", target: "Правительственные сети", status: "Мониторинг" },
                { type: "Шпионаж", severity: "medium", time: "07:55", target: "Технологические компании", status: "Обнаружена" }
            ],
            riskLevel: "Высокий",
            affectedSectors: ["Правительство", "Технологии", "Оборона"]
        },
        { 
            country: "Россия", 
            lat: 61.5240, 
            lng: 105.3188, 
            threats: 32, 
            severity: "high", 
            types: ["Ransomware", "Кибершпионаж", "Криптоджекинг"],
            recentAttacks: [
                { type: "Ransomware", severity: "critical", time: "14:20", target: "Критическая инфраструктура", status: "Активна" },
                { type: "Криптоджекинг", severity: "medium", time: "13:10", target: "Корпоративные сети", status: "Нейтрализована" }
            ],
            riskLevel: "Высокий",
            affectedSectors: ["Энергетика", "Транспорт", "Финансы"]
        },
        { 
            country: "Германия", 
            lat: 51.1657, 
            lng: 10.4515, 
            threats: 28, 
            severity: "medium", 
            types: ["Фишинг", "Мошенничество", "Утечки данных"],
            recentAttacks: [
                { type: "Фишинг", severity: "medium", time: "12:45", target: "Банковские клиенты", status: "Блокирована" }
            ],
            riskLevel: "Средний",
            affectedSectors: ["Финансы", "Розничная торговля"]
        },
        { 
            country: "Бразилия", 
            lat: -14.2350, 
            lng: -51.9253, 
            threats: 22, 
            severity: "medium", 
            types: ["Ботнеты", "Спам", "Социальная инженерия"],
            recentAttacks: [
                { type: "Ботнет", severity: "medium", time: "16:30", target: "Пользовательские устройства", status: "Активен" }
            ],
            riskLevel: "Средний",
            affectedSectors: ["Телекоммуникации", "Потребители"]
        },
        { 
            country: "Япония", 
            lat: 36.2048, 
            lng: 138.2529, 
            threats: 25, 
            severity: "medium", 
            types: ["Целевые атаки", "Промышленный шпионаж"],
            recentAttacks: [
                { type: "Целевая атака", severity: "high", time: "15:20", target: "Автомобильная промышленность", status: "Расследуется" }
            ],
            riskLevel: "Средний",
            affectedSectors: ["Автопром", "Электроника"]
        }
    ];
    
    threatData = countriesData;
    createThreatSpheres();
}

// Создание сфер для угроз
function createThreatSpheres() {
    threatSpheres.forEach(sphere => scene.remove(sphere));
    threatSpheres = [];
    
    threatData.forEach((country, index) => {
        // Конвертация географических координат в 3D координаты
        const phi = (90 - country.lat) * (Math.PI / 180);
        const theta = (country.lng + 180) * (Math.PI / 180);
        
        const radius = 2.05; // Чуть выше поверхности Земли
        
        const x = -(radius * Math.sin(phi) * Math.cos(theta));
        const y = radius * Math.cos(phi);
        const z = radius * Math.sin(phi) * Math.sin(theta);
        
        // Размер сферы - теперь нормальный!
        const sphereSize = Math.min(0.04 + (country.threats / 400), 0.07);
        
        const geometry = new THREE.SphereGeometry(sphereSize, 12, 12);
        
        // Цвет в зависимости от уровня угрозы
        let color;
        switch(country.severity) {
            case 'critical': color = new THREE.Color(0xdc3545); break;
            case 'high': color = new THREE.Color(0xfd7e14); break;
            case 'medium': color = new THREE.Color(0xffc107); break;
            case 'low': color = new THREE.Color(0x20c997); break;
        }
        
        const material = new THREE.MeshPhongMaterial({ 
            color: color,
            emissive: color,
            emissiveIntensity: 0.5, // Чуть увеличил свечение
            transparent: true,
            opacity: 0.9
        });
        
        const sphere = new THREE.Mesh(geometry, material);
        sphere.position.set(x, y, z);
        sphere.userData = { countryIndex: index, country: country };
        
        scene.add(sphere);
        threatSpheres.push(sphere);
    });
    
    // Добавляем обработчики событий для сфер
    addSphereInteractivity();
}


// Добавление интерактивности сферам
function addSphereInteractivity() {
    const raycaster = new THREE.Raycaster();
    const mouse = new THREE.Vector2();
    const tooltip = document.getElementById('threatTooltip');
    
    function onMouseMove(event) {
        const rect = renderer.domElement.getBoundingClientRect();
        mouse.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
        mouse.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;
        
        raycaster.setFromCamera(mouse, camera);
        const intersects = raycaster.intersectObjects(threatSpheres);
        
        if (intersects.length > 0) {
            const country = intersects[0].object.userData.country;
            
            tooltip.style.display = 'block';
            tooltip.style.left = (event.clientX + 10) + 'px';
            tooltip.style.top = (event.clientY + 10) + 'px';
            
            tooltip.innerHTML = `
                <strong>${country.country}</strong><br>
                Угроз: ${country.threats}<br>
                Уровень: ${getSeverityText(country.severity)}<br>
                <small>Кликните для деталей</small>
            `;
            
            renderer.domElement.style.cursor = 'pointer';
        } else {
            tooltip.style.display = 'none';
            renderer.domElement.style.cursor = 'default';
        }
    }
    
    function onMouseClick(event) {
        const rect = renderer.domElement.getBoundingClientRect();
        mouse.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
        mouse.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;
        
        raycaster.setFromCamera(mouse, camera);
        const intersects = raycaster.intersectObjects(threatSpheres);
        
        if (intersects.length > 0) {
            const country = intersects[0].object.userData.country;
            showThreatDetails(country);
        }
    }
    
    renderer.domElement.addEventListener('mousemove', onMouseMove);
    renderer.domElement.addEventListener('click', onMouseClick);
}

// Показать детали угрозы
function showThreatDetails(country) {
    const modal = document.getElementById('threatModal');
    const modalTitle = document.getElementById('modalTitle');
    const modalContent = document.getElementById('modalContent');
    
    modalTitle.textContent = `Угрозы в ${country.country}`;
    
    modalContent.innerHTML = `
        <div class="threat-details-grid">
            <div class="detail-item">
                <div class="detail-label">Общее количество угроз</div>
                <div class="detail-value">${country.threats}</div>
            </div>
            <div class="detail-item">
                <div class="detail-label">Уровень риска</div>
                <div class="detail-value">
                    <span class="severity-badge badge-${country.severity}">
                        ${getSeverityText(country.severity)}
                    </span>
                </div>
            </div>
            <div class="detail-item">
                <div class="detail-label">Основные типы атак</div>
                <div class="detail-value">${country.types.join(', ')}</div>
            </div>
            <div class="detail-item">
                <div class="detail-label">Затронутые секторы</div>
                <div class="detail-value">${country.affectedSectors.join(', ')}</div>
            </div>
        </div>
        
        <h5 class="cyber-text mt-4">Последние атаки:</h5>
        <div class="attack-list">
            ${country.recentAttacks.map(attack => `
                <div class="attack-item attack-${attack.severity}">
                    <div class="d-flex justify-content-between">
                        <strong>${attack.type}</strong>
                        <span class="severity-badge badge-${attack.severity}">
                            ${getSeverityText(attack.severity)}
                        </span>
                    </div>
                    <div class="detail-label mt-1">Время: ${attack.time}</div>
                    <div>Цель: ${attack.target}</div>
                    <div class="text-${attack.status === 'Активна' ? 'danger' : attack.status === 'Блокирована' ? 'success' : 'warning'}">
                        Статус: ${attack.status}
                    </div>
                </div>
            `).join('')}
        </div>
        
        <div class="mt-4 p-3 bg-dark rounded">
            <small class="text-warning">
                <i class="bi bi-exclamation-triangle me-1"></i>
                Рекомендации: ${getRecommendations(country.severity)}
            </small>
        </div>
    `;
    
    modal.style.display = 'block';
}

// Закрыть модальное окно
function closeThreatModal() {
    document.getElementById('threatModal').style.display = 'none';
}

// Получить рекомендации по уровню угрозы
function getRecommendations(severity) {
    const recommendations = {
        'critical': 'Требуется немедленное вмешательство. Усилить мониторинг и применить экстренные меры защиты.',
        'high': 'Высокий риск. Рекомендуется проверить системы защиты и обновить сигнатуры угроз.',
        'medium': 'Средний риск. Рекомендуется стандартный мониторинг и обновление защитных мер.',
        'low': 'Низкий риск. Стандартные меры защиты достаточны.'
    };
    return recommendations[severity] || 'Рекомендации отсутствуют.';
}

// Вспомогательные функции
function getSeverityText(severity) {
    const severityMap = {
        'critical': 'Критический',
        'high': 'Высокий',
        'medium': 'Средний',
        'low': 'Низкий'
    };
    return severityMap[severity] || 'Неизвестно';
}

function resetCamera() {
    controls.reset();
}

function toggleRotation() {
    isRotating = !isRotating;
    const icon = document.getElementById('rotationIcon');
    icon.className = isRotating ? 'bi bi-pause-circle' : 'bi bi-play-circle';
}

function onWindowResize() {
    const container = document.getElementById('threatMap3d');
    camera.aspect = container.clientWidth / container.clientHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(container.clientWidth, container.clientHeight);
}

// Анимация
function animate() {
    requestAnimationFrame(animate);
    
    if (isRotating) {
        earth.rotation.y += 0.001;
    }
    
    // Легкая анимация пульсации для сфер угроз
    threatSpheres.forEach((sphere, index) => {
        const scale = 1 + Math.sin(Date.now() * 0.003 + index) * 0.03; // Легкая пульсация
        sphere.scale.set(scale, scale, scale);
    });
    
    controls.update();
    renderer.render(scene, camera);
}

// Остальной код загрузки данных...
async function loadThreatData() {
    console.log('Загрузка симулированных данных мониторинга угроз...');
    
    await Promise.all([
        loadStats(),
        loadActiveThreats(),
        loadLiveFeed()
    ]);
    
    // Инициализируем 3D карту после загрузки страницы
    setTimeout(init3DMap, 100);
    
    updateLastUpdateTime();
    setInterval(loadThreatData, 30000);
}

// Остальные функции (loadStats, loadActiveThreats, loadLiveFeed) остаются без изменений
// ... (вставь сюда функции из предыдущего кода)

// Инициализация
document.addEventListener('DOMContentLoaded', function() {
    loadThreatData();
});
</script>

<!-- Вставь сюда остальной JavaScript код из предыдущей версии -->
<script>
// Загрузка статистики
async function loadStats() {
    try {
        const simulatedStats = {
            success_rate: Math.floor(Math.random() * 20) + 80,
            avg_response_time: (Math.random() * 2 + 0.5).toFixed(1) + 'с',
            threats_today: Math.floor(Math.random() * 50) + 10,
            total_threats: Math.floor(Math.random() * 1000) + 500
        };
        
        const statsGrid = document.getElementById('statsGrid');
        statsGrid.innerHTML = `
            <div class="stat-card">
                <i class="bi bi-shield-check display-6 text-success mb-2"></i>
                <h3 class="cyber-text">${simulatedStats.success_rate}%</h3>
                <p class="cyber-subtext">Эффективность защиты</p>
            </div>
            <div class="stat-card">
                <i class="bi bi-clock display-6 text-warning mb-2"></i>
                <h3 class="cyber-text">${simulatedStats.avg_response_time}</h3>
                <p class="cyber-subtext">Среднее время реакции</p>
            </div>
            <div class="stat-card">
                <i class="bi bi-exclamation-triangle display-6 text-danger mb-2"></i>
                <h3 class="cyber-text">${simulatedStats.threats_today}</h3>
                <p class="cyber-subtext">Угроз сегодня</p>
            </div>
            <div class="stat-card">
                <i class="bi bi-graph-up display-6 text-info mb-2"></i>
                <h3 class="cyber-text">${simulatedStats.total_threats}</h3>
                <p class="cyber-subtext">Всего угроз</p>
            </div>
        `;
    } catch (error) {
        console.error('Ошибка загрузки статистики:', error);
    }
}

// Загрузка активных угроз
async function loadActiveThreats() {
    try {
        const threatTypes = [
            { name: "DDoS атака", severity: "critical", description: "Распределенная атака на отказ в обслуживании" },
            { name: "Фишинг кампания", severity: "high", description: "Целенаправленные фишинг атаки на сотрудников" },
            { name: "Вредоносное ПО", severity: "medium", description: "Обнаружено подозрительное ПО в сети" },
            { name: "Подозрительная активность", severity: "low", description: "Необычная сетевая активность" }
        ];
        
        const simulatedThreats = {
            threats: Array.from({length: Math.floor(Math.random() * 3) + 1}, () => {
                const threat = threatTypes[Math.floor(Math.random() * threatTypes.length)];
                return {
                    ...threat,
                    detected: new Date(Date.now() - Math.random() * 3600000).toISOString(),
                    affected_users: Math.floor(Math.random() * 50) + 1
                };
            })
        };
        
        const container = document.getElementById('activeThreatsList');
        const countElement = document.getElementById('activeThreatsCount');
        
        countElement.textContent = simulatedThreats.threats.length;
        
        if (simulatedThreats.threats.length === 0) {
            container.innerHTML = `
                <div class="text-center py-4">
                    <i class="bi bi-check-circle display-4 text-success"></i>
                    <p class="cyber-subtext mt-2">Активных угроз не обнаружено</p>
                </div>
            `;
            return;
        }
        
        container.innerHTML = simulatedThreats.threats.map(threat => `
            <div class="threat-card p-3 mb-3 threat-${threat.severity}">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h6 class="cyber-text mb-1">${threat.name}</h6>
                        <p class="cyber-subtext small mb-2">${threat.description}</p>
                        <div class="d-flex gap-2 flex-wrap">
                            <span class="severity-badge badge-${threat.severity}">
                                ${threat.severity === 'critical' ? 'Критическая' : 
                                  threat.severity === 'high' ? 'Высокая' :
                                  threat.severity === 'medium' ? 'Средняя' : 'Низкая'}
                            </span>
                            <span class="cyber-subtext small">
                                <i class="bi bi-clock"></i> ${new Date(threat.detected).toLocaleTimeString()}
                            </span>
                        </div>
                    </div>
                    <div class="text-end">
                        <small class="cyber-subtext">${threat.affected_users} пользователей</small>
                    </div>
                </div>
            </div>
        `).join('');
    } catch (error) {
        console.error('Ошибка загрузки угроз:', error);
    }
}

// Загрузка живой ленты
async function loadLiveFeed() {
    try {
        const eventTypes = [
            { description: "Подозрительное соединение с внешним IP", severity: "medium", source_ip: "192.168.1." + Math.floor(Math.random() * 255), action: "Блокировано" },
            { description: "Попытка несанкционированного доступа", severity: "high", source_ip: "10.0.2." + Math.floor(Math.random() * 255), action: "Исследуется" },
            { description: "Обнаружено вредоносное ПО", severity: "critical", source_ip: "172.16.1." + Math.floor(Math.random() * 255), action: "Блокировано" },
            { description: "Аномальная сетевая активность", severity: "low", source_ip: "192.168.0." + Math.floor(Math.random() * 255), action: "Мониторинг" }
        ];
        
        const simulatedEvents = {
            events: Array.from({length: 8}, () => {
                const event = eventTypes[Math.floor(Math.random() * eventTypes.length)];
                return {
                    ...event,
                    timestamp: new Date(Date.now() - Math.random() * 300000).toISOString()
                };
            })
        };
        
        const container = document.getElementById('liveFeed');
        container.innerHTML = simulatedEvents.events.map(event => `
            <div class="feed-item">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <span class="severity-badge badge-${event.severity} me-2">
                            ${event.severity}
                        </span>
                        <span class="cyber-text">${event.description}</span>
                    </div>
                    <div class="text-end">
                        <small class="cyber-subtext">${event.source_ip}</small>
                        <br>
                        <small class="text-${event.action === 'Блокировано' ? 'success' : 'warning'}">
                            ${event.action}
                        </small>
                    </div>
                </div>
                <small class="cyber-subtext">
                    ${new Date(event.timestamp).toLocaleTimeString()}
                </small>
            </div>
        `).join('');
    } catch (error) {
        console.error('Ошибка загрузки ленты:', error);
    }
}

// Обновление времени
function updateLastUpdateTime() {
    const element = document.getElementById('lastUpdate');
    element.textContent = `Обновлено: ${new Date().toLocaleTimeString()}`;
}
</script>
{% endblock %}