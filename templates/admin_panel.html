{% extends "base.html" %}

{% block title %}Админ-панель | CyberGuardian{% endblock %}

{% block content %}
<div class="container-max section-spacing">
    {% if not authenticated %}
    <!-- Форма входа -->
    <div class="row justify-content-center">
        <div class="col-md-6 col-lg-5">
            <div class="cyber-card fade-in-up">
                <div class="text-center mb-4">
                    <i class="bi bi-shield-lock" style="font-size: 3rem; color: var(--cyber-primary);"></i>
                    <h2 class="cyber-title mt-3">Админ-панель</h2>
                    <p class="cyber-subtext">Доступ только для авторизованных сотрудников</p>
                </div>

                {% if error %}
                <div class="alert alert-danger d-flex align-items-center mb-4" role="alert" style="background: rgba(255, 107, 107, 0.1); border: 1px solid var(--cyber-danger); color: var(--cyber-danger);">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                    <div>Неверный пароль администратора</div>
                </div>
                {% endif %}

                <form method="POST">
                    {% if csrf_token %}
                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                    {% endif %}
                    
                    <div class="mb-4">
                        <label for="admin_password" class="form-label cyber-text-bright">Пароль доступа</label>
                        <div class="input-group">
                            <span class="input-group-text" style="background: var(--cyber-darker); border-color: var(--cyber-border); color: var(--cyber-primary);">
                                <i class="bi bi-key-fill"></i>
                            </span>
                            <input type="password" class="form-control" id="admin_password" name="admin_password" 
                                   required placeholder="Введите пароль..."
                                   style="background: var(--cyber-darker); border-color: var(--cyber-border); color: var(--cyber-text);">
                        </div>
                    </div>
                    
                    <button type="submit" class="btn-cyber w-100">
                        <i class="bi bi-box-arrow-in-right"></i>
                        Войти в систему
                    </button>
                </form>
            </div>
        </div>
    </div>
    {% else %}
    <!-- Главная панель -->
    <div class="d-flex justify-content-between align-items-center mb-4 fade-in-up">
        <div>
            <h2 class="cyber-title">
                <i class="bi bi-speedometer2 text-primary me-2"></i>Панель управления
            </h2>
            <p class="cyber-subtext">Мониторинг и управление системой безопасности</p>
        </div>
        <a href="?logout=true" class="btn-cyber-danger">
            <i class="bi bi-box-arrow-right"></i> Выйти
        </a>
    </div>

    <!-- Статистика -->
    <div class="row g-4 mb-5 fade-in-up">
        <div class="col-md-3">
            <div class="stat-card">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <div class="stat-number">{{ stats.total_users }}</div>
                        <div class="stat-label">Пользователи</div>
                    </div>
                    <i class="bi bi-people fs-1 opacity-50" style="color: var(--cyber-primary);"></i>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <div class="stat-number" style="color: var(--cyber-danger);">{{ stats.blocked_ips_count }}</div>
                        <div class="stat-label">Заблокировано IP</div>
                    </div>
                    <i class="bi bi-shield-slash fs-1 opacity-50" style="color: var(--cyber-danger);"></i>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <div class="stat-number" style="color: var(--cyber-success);">{{ stats.total_lessons }}</div>
                        <div class="stat-label">Уроки пройдены</div>
                    </div>
                    <i class="bi bi-mortarboard fs-1 opacity-50" style="color: var(--cyber-success);"></i>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <div class="stat-number" style="color: var(--cyber-warning);">{{ stats.total_encryptions }}</div>
                        <div class="stat-label">Шифрования</div>
                    </div>
                    <i class="bi bi-file-earmark-lock fs-1 opacity-50" style="color: var(--cyber-warning);"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Управление пользователями -->
    <div class="cyber-card fade-in-up">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h4 class="cyber-text-bright m-0">
                <i class="bi bi-people-fill me-2"></i>Пользователи
            </h4>
            <div class="cyber-badge cyber-badge-primary">
                Всего: {{ stats.total_users }}
            </div>
        </div>

        <div class="table-responsive">
            <table class="table table-dark table-hover" style="--bs-table-bg: transparent;">
                <thead>
                    <tr style="border-bottom: 2px solid var(--cyber-border);">
                        <th scope="col" class="py-3">ID</th>
                        <th scope="col" class="py-3">Пользователь</th>
                        <th scope="col" class="py-3">Email</th>
                        <th scope="col" class="py-3">Регистрация</th>
                        <th scope="col" class="py-3">Прогресс</th>
                        <th scope="col" class="py-3">Статус</th>
                        <th scope="col" class="py-3 text-end">Действия</th>
                    </tr>
                </thead>
                <tbody style="border-top: none;">
                    {% for user in users %}
                    <tr style="border-bottom: 1px solid var(--cyber-border); vertical-align: middle;">
                        <td><span class="cyber-text-bright">#{{ user.id }}</span></td>
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="rounded-circle bg-primary d-flex align-items-center justify-content-center me-2" style="width: 32px; height: 32px; font-size: 0.8rem;">
                                    {{ user.username[0]|upper }}
                                </div>
                                {{ user.username }}
                            </div>
                        </td>
                        <td class="cyber-subtext">{{ user.email }}</td>
                        <td class="cyber-subtext">{{ user.created_at.strftime('%d.%m.%Y') if user.created_at else '-' }}</td>
                        <td>
                            <div class="d-flex gap-2">
                                <span class="badge bg-info bg-opacity-10 text-info border border-info border-opacity-25" title="Уроков">
                                    <i class="bi bi-book me-1"></i>{{ user.lessons_completed }}
                                </span>
                                <span class="badge bg-warning bg-opacity-10 text-warning border border-warning border-opacity-25" title="Шифрований">
                                    <i class="bi bi-lock me-1"></i>{{ user.encryption_count }}
                                </span>
                            </div>
                        </td>
                        <td>
                            {% if user.is_active %}
                                <span class="badge bg-success bg-opacity-10 text-success border border-success border-opacity-25">
                                    <i class="bi bi-check-circle me-1"></i>Активен
                                </span>
                            {% else %}
                                <span class="badge bg-danger bg-opacity-10 text-danger border border-danger border-opacity-25">
                                    <i class="bi bi-dash-circle me-1"></i>Заблокирован
                                </span>
                            {% endif %}
                        </td>
                        <td class="text-end">
                            <div class="btn-group">
                                {% if user.is_active %}
                                <button onclick="banUser({{ user.id }}, '{{ user.username }}')" class="btn btn-sm btn-outline-warning" title="Заблокировать">
                                    <i class="bi bi-slash-circle"></i>
                                </button>
                                {% else %}
                                <button onclick="unbanUser({{ user.id }}, '{{ user.username }}')" class="btn btn-sm btn-outline-success" title="Разблокировать">
                                    <i class="bi bi-check-circle"></i>
                                </button>
                                {% endif %}

                                <button onclick="deleteUser({{ user.id }}, '{{ user.username }}')" class="btn btn-sm btn-outline-danger" title="Удалить">
                                    <i class="bi bi-trash"></i>
                                </button>
                                <button onclick="loadUserStories({{ user.id }})" class="btn btn-sm btn-outline-info" title="Истории">
                                    <i class="bi bi-journal-text"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Пагинация -->
        {% if users_pagination and users_pagination.pages > 1 %}
        <nav aria-label="Пагинация" class="mt-4">
            <ul class="pagination justify-content-center">
                {% if users_pagination.has_prev %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ users_pagination.prev_num }}" style="background: var(--cyber-darker); border-color: var(--cyber-border); color: var(--cyber-text);">
                        <i class="bi bi-chevron-left"></i>
                    </a>
                </li>
                {% endif %}
                
                <li class="page-item disabled">
                    <span class="page-link" style="background: var(--cyber-bg-card); border-color: var(--cyber-border); color: var(--cyber-primary);">
                        Стр. {{ users_pagination.page }} из {{ users_pagination.pages }}
                    </span>
                </li>
                
                {% if users_pagination.has_next %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ users_pagination.next_num }}" style="background: var(--cyber-darker); border-color: var(--cyber-border); color: var(--cyber-text);">
                        <i class="bi bi-chevron-right"></i>
                    </a>
                </li>
                {% endif %}
            </ul>
        </nav>
        {% endif %}
    </div>

    <!-- Модальное окно историй пользователя -->
    <div class="modal fade" id="userStoriesModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content" style="background: var(--cyber-bg-card); border: 2px solid var(--cyber-primary);">
                <div class="modal-header border-bottom border-secondary">
                    <h5 class="modal-title cyber-text-bright" id="storiesModalTitle">Истории пользователя</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="storiesLoader" class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Загрузка...</span>
                        </div>
                    </div>
                    <div id="storiesList" class="d-none">
                        <!-- Здесь будут истории -->
                    </div>
                    <div id="noStoriesMessage" class="text-center py-4 d-none text-muted">
                        У пользователя нет опубликованных историй
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно редактирования истории -->
    <div class="modal fade" id="editStoryModal" tabindex="-1" aria-hidden="true" style="z-index: 1060;">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content" style="background: var(--cyber-bg-card); border: 2px solid var(--cyber-warning);">
                <div class="modal-header border-bottom border-secondary">
                    <h5 class="modal-title cyber-text-bright">Редактировать историю</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editStoryForm">
                        <input type="hidden" id="editStoryId">
                        <div class="mb-3">
                            <label for="editStoryTitle" class="form-label text-white">Заголовок</label>
                            <input type="text" class="form-control bg-dark text-white border-secondary" id="editStoryTitle" required>
                        </div>
                        <div class="mb-3">
                            <label for="editStoryContent" class="form-label text-white">Содержание</label>
                            <textarea class="form-control bg-dark text-white border-secondary" id="editStoryContent" rows="10" required></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer border-top border-secondary">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="button" class="btn btn-warning" onclick="saveStoryChanges()">Сохранить изменения</button>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>

    // Функции для работы с API админки
    async function apiRequest(endpoint, data) {
        try {
            const response = await fetch(`/admin/${endpoint}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify(data)
            });
            
            const result = await response.json();
            
            if (response.ok) {
                showNotification(result.message || 'Успешно!', 'success');
                // Перезагружаем страницу через 1 секунду для обновления данных
                setTimeout(() => window.location.reload(), 1000);
            } else {
                showNotification(result.error || 'Ошибка выполнения операции', 'danger');
            }
        } catch (error) {
            console.error('Error:', error);
            showNotification('Произошла ошибка сети', 'danger');
        }
    }

    function banUser(userId, username) {
        if (confirm(`Вы уверены, что хотите заблокировать пользователя ${username}?`)) {
            apiRequest('ban-user', { user_id: userId, reason: 'Административная блокировка' });
        }
    }

    function unbanUser(userId, username) {
        if (confirm(`Разблокировать пользователя ${username}?`)) {
            apiRequest('unban-user', { user_id: userId });
        }
    }


    function deleteUser(userId, username) {
        if (confirm(`ВНИМАНИЕ! Вы собираетесь удалить пользователя ${username}.\nЭто действие НЕОБРАТИМО!\n\nПродолжить?`)) {
            apiRequest('delete-user', { user_id: userId });
        }
    }

    // === Управление историями ===
    let storiesModal;
    let editStoryModal;

    document.addEventListener('DOMContentLoaded', function() {
        storiesModal = new bootstrap.Modal(document.getElementById('userStoriesModal'));
        editStoryModal = new bootstrap.Modal(document.getElementById('editStoryModal'));
    });

    async function loadUserStories(userId) {
        storiesModal.show();
        
        const loader = document.getElementById('storiesLoader');
        const list = document.getElementById('storiesList');
        const noStories = document.getElementById('noStoriesMessage');
        const title = document.getElementById('storiesModalTitle');
        
        loader.classList.remove('d-none');
        list.classList.add('d-none');
        noStories.classList.add('d-none');
        
        try {
            const response = await fetch(`/admin/get-user-stories/${userId}`);
            const data = await response.json();
            
            if (data.success) {
                title.textContent = `Истории пользователя ${data.username}`;
                list.innerHTML = '';
                
                if (data.stories.length === 0) {
                    noStories.classList.remove('d-none');
                } else {
                    data.stories.forEach(story => {
                        const item = document.createElement('div');
                        item.className = 'card bg-dark border-secondary mb-3';
                        item.innerHTML = `
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h5 class="card-title text-info mb-0">${story.title}</h5>
                                    <span class="badge bg-secondary">${story.category}</span>
                                </div>
                                <p class="card-text text-light small">${story.content}</p>
                                <div class="d-flex justify-content-between align-items-center mt-3">
                                    <div class="text-muted small">
                                        <i class="bi bi-calendar me-1"></i>${story.created_at}
                                        <span class="mx-2">|</span>
                                        <i class="bi bi-eye me-1"></i>${story.views}
                                        <span class="mx-2">|</span>
                                        <i class="bi bi-heart me-1"></i>${story.likes}
                                    </div>
                                    <div class="btn-group">
                                        <button onclick="editStory(${story.id})" class="btn btn-sm btn-outline-warning">
                                            <i class="bi bi-pencil me-1"></i>Редактировать
                                        </button>
                                        <button onclick="deleteStory(${story.id})" class="btn btn-sm btn-outline-danger">
                                            <i class="bi bi-trash me-1"></i>Удалить
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                        list.appendChild(item);
                    });
                    list.classList.remove('d-none');
                }
            } else {
                showNotification(data.error || 'Ошибка загрузки историй', 'danger');
            }
        } catch (error) {
            console.error('Error:', error);
            showNotification('Ошибка сети при загрузке историй', 'danger');
        } finally {
            loader.classList.add('d-none');
        }
    }

    async function editStory(storyId) {
        try {
            const response = await fetch(`/admin/get-story/${storyId}`);
            const data = await response.json();
            
            if (data.success) {
                document.getElementById('editStoryId').value = data.story.id;
                document.getElementById('editStoryTitle').value = data.story.title;
                document.getElementById('editStoryContent').value = data.story.content;
                
                editStoryModal.show();
            } else {
                showNotification('Ошибка загрузки истории', 'danger');
            }
        } catch (error) {
            console.error('Error:', error);
            showNotification('Ошибка сети', 'danger');
        }
    }

    async function saveStoryChanges() {
        const id = document.getElementById('editStoryId').value;
        const title = document.getElementById('editStoryTitle').value;
        const content = document.getElementById('editStoryContent').value;
        
        try {
            await apiRequest('update-story', {
                story_id: id,
                title: title,
                content: content
            });
            
            editStoryModal.hide();
            // Не перезагружаем страницу, просто уведомляем
            // Можно было бы обновить список, но для простоты оставим так
            // Пользователь может закрыть и открыть список заново
        } catch (error) {
            console.error('Error:', error);
        }
    }

    async function deleteStory(storyId) {
        if (confirm('Вы уверены, что хотите удалить эту историю? Это действие необратимо.')) {
            try {
                await apiRequest('delete-story', { story_id: storyId });
                // Скрываем модальное окно историй, чтобы обновить состояние
                storiesModal.hide();
            } catch (error) {
                console.error('Error:', error);
            }
        }
    }
</script>
{% endblock %}

