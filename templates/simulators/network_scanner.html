{% extends "base.html" %}

{% block title %}–°–∫–∞–Ω–µ—Ä —Å–µ—Ç–∏ - CyberGuardian{% endblock %}

{% block extra_css %}
<style>
.scanner-interface {
    background: #0a0a0a;
    border: 2px solid var(--cyber-primary);
    border-radius: 15px;
    padding: 2rem;
    font-family: 'Courier New', monospace;
}

.scan-controls {
    display: grid;
    grid-template-columns: 1fr auto;
    gap: 1rem;
    margin-bottom: 2rem;
}

.target-input {
    background: rgba(20, 20, 20, 0.8);
    border: 1px solid var(--cyber-border);
    border-radius: 8px;
    color: var(--cyber-primary);
    padding: 0.75rem 1rem;
    font-family: 'Courier New', monospace;
}

.scan-results {
    margin-top: 2rem;
    max-height: 500px;
    overflow-y: auto;
}

.port-item {
    display: grid;
    grid-template-columns: 80px 1fr auto auto;
    gap: 1rem;
    padding: 1rem;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    align-items: center;
}

.port-number {
    background: rgba(0, 136, 255, 0.2);
    padding: 0.5rem;
    border-radius: 5px;
    text-align: center;
    font-weight: bold;
}

.status-open {
    color: var(--cyber-primary);
}

.status-closed {
    color: var(--cyber-subtext);
}

.vulnerability-high {
    color: #ff4444;
}

.vulnerability-medium {
    color: #ffaa00;
}

.vulnerability-low {
    color: #00ff00;
}

.scan-animation {
    display: flex;
    justify-content: center;
    gap: 0.5rem;
    margin: 2rem 0;
}

.scan-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: var(--cyber-primary);
    animation: scanPulse 1.5s infinite;
}

.scan-dot:nth-child(2) { animation-delay: 0.2s; }
.scan-dot:nth-child(3) { animation-delay: 0.4s; }
.scan-dot:nth-child(4) { animation-delay: 0.6s; }
.scan-dot:nth-child(5) { animation-delay: 0.8s; }

@keyframes scanPulse {
    0%, 100% { opacity: 0.3; transform: scale(1); }
    50% { opacity: 1; transform: scale(1.2); }
}

.recommendations {
    background: rgba(0, 136, 255, 0.1);
    border: 1px solid var(--cyber-secondary);
    border-radius: 10px;
    padding: 1.5rem;
    margin-top: 2rem;
}

.scan-stats {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 1rem;
    margin: 1.5rem 0;
}

.stat-card {
    background: rgba(30, 30, 30, 0.8);
    padding: 1rem;
    border-radius: 8px;
    text-align: center;
}
</style>
{% endblock %}

{% block content %}
<div class="container">
    <nav class="mb-4">
        <a href="{{ url_for('simulators.simulators_home') }}" class="btn btn-cyber-outline">
            <i class="bi bi-arrow-left me-2"></i>–ù–∞–∑–∞–¥ –∫ —Å–∏–º—É–ª—è—Ç–æ—Ä–∞–º
        </a>
    </nav>

    <div class="row">
        <div class="col-lg-10 mx-auto">
            <div class="cyber-card p-4">
                <div class="text-center mb-4">
                    <h1 class="cyber-text glow-text mb-3">
                        <i class="bi bi-radar me-2"></i>–°–ö–ê–ù–ï–† –°–ï–¢–ò
                    </h1>
                    <p class="cyber-subtext">
                        –°–∏–º—É–ª—è—Ü–∏—è —Å–µ—Ç–µ–≤–æ–≥–æ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è. –û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –æ—Ç–∫—Ä—ã—Ç—ã—Ö –ø–æ—Ä—Ç–æ–≤ –∏ —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π.
                    </p>
                </div>

                <!-- –≠–ª–µ–º–µ–Ω—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
                <div class="scanner-interface">
                    <div class="scan-controls">
                        <input type="text" id="targetInput" class="target-input" 
                               placeholder="–í–≤–µ–¥–∏—Ç–µ IP-–∞–¥—Ä–µ—Å –∏–ª–∏ –¥–æ–º–µ–Ω (–Ω–∞–ø—Ä–∏–º–µ—Ä: 192.168.1.1)"
                               value="192.168.1.1">
                        <button id="scanBtn" class="btn btn-cyber" onclick="startScan()">
                            <i class="bi bi-play-circle me-2"></i>–ó–ê–ü–£–°–¢–ò–¢–¨ –°–ö–ê–ù–ò–†–û–í–ê–ù–ò–ï
                        </button>
                    </div>

                    <!-- –ê–Ω–∏–º–∞—Ü–∏—è —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è -->
                    <div id="scanAnimation" class="scan-animation" style="display: none;">
                        <div class="scan-dot"></div>
                        <div class="scan-dot"></div>
                        <div class="scan-dot"></div>
                        <div class="scan-dot"></div>
                        <div class="scan-dot"></div>
                    </div>

                    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
                    <div id="scanStats" class="scan-stats" style="display: none;">
                        <div class="stat-card">
                            <div class="stat-value" id="portsOpen">0</div>
                            <div class="stat-label">–û–¢–ö–†–´–¢–´–• –ü–û–†–¢–û–í</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="portsScanned">0</div>
                            <div class="stat-label">–ü–†–û–°–ö–ê–ù–ò–†–û–í–ê–ù–û</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="vulnCount">0</div>
                            <div class="stat-label">–£–Ø–ó–í–ò–ú–û–°–¢–ï–ô</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="scanTime">0—Å</div>
                            <div class="stat-label">–í–†–ï–ú–Ø –°–ö–ê–ù–ò–†–û–í–ê–ù–ò–Ø</div>
                        </div>
                    </div>

                    <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã -->
                    <div id="scanResults" class="scan-results" style="display: none;">
                        <h5 class="cyber-text mb-3">üìä –†–ï–ó–£–õ–¨–¢–ê–¢–´ –°–ö–ê–ù–ò–†–û–í–ê–ù–ò–Ø:</h5>
                        <div id="portsList"></div>
                    </div>

                    <!-- –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ -->
                    <div id="recommendations" class="recommendations" style="display: none;">
                        <h5 class="cyber-text mb-3">üõ°Ô∏è –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò –ü–û –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–ò:</h5>
                        <div id="recommendationsList"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function startScan() {
    const target = document.getElementById('targetInput').value.trim();
    if (!target) {
        showNotification('‚ö†Ô∏è –í–≤–µ–¥–∏—Ç–µ IP-–∞–¥—Ä–µ—Å –∏–ª–∏ –¥–æ–º–µ–Ω –¥–ª—è —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è', 'warning');
        return;
    }

    const scanBtn = document.getElementById('scanBtn');
    const scanAnimation = document.getElementById('scanAnimation');
    const scanStats = document.getElementById('scanStats');
    const scanResults = document.getElementById('scanResults');
    const recommendations = document.getElementById('recommendations');

    // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
    scanBtn.disabled = true;
    scanBtn.innerHTML = '<div class="spinner-border spinner-border-sm me-2"></div>–°–ö–ê–ù–ò–†–£–ï–ú...';

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    scanAnimation.style.display = 'flex';
    scanStats.style.display = 'grid';

    // –°–∏–º—É–ª—è—Ü–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
    let portsScanned = 0;
    const totalPorts = 1000;
    const progressInterval = setInterval(() => {
        portsScanned += Math.floor(Math.random() * 50) + 10;
        if (portsScanned >= totalPorts) {
            portsScanned = totalPorts;
            clearInterval(progressInterval);
            completeScan(target);
        }
        document.getElementById('portsScanned').textContent = portsScanned;
        document.getElementById('scanTime').textContent = Math.floor(portsScanned / 100) + '—Å';
    }, 100);

    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
    scanResults.style.display = 'none';
    recommendations.style.display = 'none';
}

function completeScan(target) {
    const scanBtn = document.getElementById('scanBtn');
    const scanAnimation = document.getElementById('scanAnimation');
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä
    fetch('/simulators/api/scan-network', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({target: target})
    })
    .then(response => response.json())
    .then(data => {
        // –°–∫—Ä—ã–≤–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é
        scanAnimation.style.display = 'none';
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        document.getElementById('portsOpen').textContent = data.ports_found;
        document.getElementById('vulnCount').textContent = data.ports.filter(p => p.vulnerability !== 'None').length;

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
        displayScanResults(data);
        
        // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
        scanBtn.disabled = false;
        scanBtn.innerHTML = '<i class="bi bi-arrow-repeat me-2"></i>–ü–û–í–¢–û–†–ò–¢–¨ –°–ö–ê–ù–ò–†–û–í–ê–ù–ò–ï';
    });
}

function displayScanResults(data) {
    const portsList = document.getElementById('portsList');
    const recommendationsList = document.getElementById('recommendationsList');
    const scanResults = document.getElementById('scanResults');
    const recommendations = document.getElementById('recommendations');

    // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –ø–æ—Ä—Ç—ã
    portsList.innerHTML = '';
    data.ports.forEach(port => {
        if (port.status === 'open') {
            const portItem = document.createElement('div');
            portItem.className = 'port-item';
            portItem.innerHTML = `
                <div class="port-number">${port.port}</div>
                <div>${port.service}</div>
                <div class="status-open">‚óè –û–¢–ö–†–´–¢</div>
                <div class="vulnerability-${port.vulnerability.toLowerCase()}">
                    ${port.vulnerability}
                </div>
            `;
            portsList.appendChild(portItem);
        }
    });

    // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
    recommendationsList.innerHTML = '';
    data.recommendations.forEach(rec => {
        const recItem = document.createElement('div');
        recItem.className = 'mb-2';
        recItem.innerHTML = `‚Ä¢ ${rec}`;
        recommendationsList.appendChild(recItem);
    });

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
    scanResults.style.display = 'block';
    recommendations.style.display = 'block';
}

// Enter –¥–ª—è –∑–∞–ø—É—Å–∫–∞ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
document.getElementById('targetInput').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        startScan();
    }
});
</script>
{% endblock %}