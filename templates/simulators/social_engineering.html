{% extends "base.html" %}

{% block title %}–°–æ—Ü–∏–∞–ª—å–Ω–∞—è –∏–Ω–∂–µ–Ω–µ—Ä–∏—è - CyberGuardian{% endblock %}

{% block extra_css %}
<style>
.scenario-container {
    background: rgba(20, 20, 20, 0.9);
    border: 2px solid var(--cyber-primary);
    border-radius: 15px;
    padding: 2rem;
    margin-bottom: 2rem;
}

.dialogue {
    margin: 2rem 0;
}

.message {
    padding: 1rem;
    margin: 1rem 0;
    border-radius: 10px;
    max-width: 80%;
    position: relative;
}

.message.incoming {
    background: rgba(0, 136, 255, 0.2);
    border-left: 4px solid var(--cyber-secondary);
    margin-right: auto;
}

.message.outgoing {
    background: rgba(0, 255, 136, 0.2);
    border-left: 4px solid var(--cyber-primary);
    margin-left: auto;
}

.message::before {
    content: '';
    position: absolute;
    top: 10px;
    width: 8px;
    height: 8px;
    border-radius: 50%;
}

.message.incoming::before {
    left: -6px;
    background: var(--cyber-secondary);
}

.message.outgoing::before {
    right: -6px;
    background: var(--cyber-primary);
}

.options-grid {
    display: grid;
    gap: 1rem;
    margin: 2rem 0;
}

.option-card {
    background: rgba(30, 30, 30, 0.8);
    border: 2px solid var(--cyber-border);
    border-radius: 10px;
    padding: 1.5rem;
    cursor: pointer;
    transition: all 0.3s ease;
}

.option-card:hover {
    border-color: var(--cyber-primary);
    transform: translateY(-2px);
}

.option-card.selected {
    background: rgba(0, 255, 136, 0.2);
    border-color: var(--cyber-primary);
}

.psychology-tips {
    background: rgba(255, 193, 7, 0.1);
    border: 1px solid #ffc107;
    border-radius: 10px;
    padding: 1.5rem;
    margin: 2rem 0;
}

.progress-indicator {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin: 2rem 0;
    padding: 1rem;
    background: rgba(30, 30, 30, 0.8);
    border-radius: 10px;
}

.progress-text {
    color: var(--cyber-primary);
    font-weight: bold;
}

.analysis-box {
    background: rgba(0, 136, 255, 0.1);
    border: 1px solid var(--cyber-secondary);
    border-radius: 10px;
    padding: 2rem;
    margin-top: 2rem;
    animation: slideIn 0.5s ease;
}
</style>
{% endblock %}

{% block content %}
<div class="container">
    <nav class="mb-4">
        <a href="{{ url_for('simulators.simulators_home') }}" class="btn btn-cyber-outline">
            <i class="bi bi-arrow-left me-2"></i>–ù–∞–∑–∞–¥ –∫ —Å–∏–º—É–ª—è—Ç–æ—Ä–∞–º
        </a>
    </nav>

    <div class="row">
        <div class="col-lg-10 mx-auto">
            <div class="cyber-card p-4">
                <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏ –ø—Ä–æ–≥—Ä–µ—Å—Å -->
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h1 class="cyber-text glow-text mb-2">
                            <i class="bi bi-brain me-2"></i>–°–û–¶–ò–ê–õ–¨–ù–ê–Ø –ò–ù–ñ–ï–ù–ï–†–ò–Ø
                        </h1>
                        <p class="cyber-subtext">–°—Ü–µ–Ω–∞—Ä–∏–π {{ level }} –∏–∑ 5</p>
                    </div>
                    <div class="text-end">
                        <div class="cyber-badge">üèÜ {{ score }} –æ—á–∫–æ–≤</div>
                    </div>
                </div>

                <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å -->
                <div class="progress-indicator">
                    <div class="progress-text">–£—Ä–æ–≤–µ–Ω—å —Å–ª–æ–∂–Ω–æ—Å—Ç–∏: 
                        <span class="text-warning">{% if level == 1 %}–ù–∞—á–∏–Ω–∞—é—â–∏–π{% elif level == 2 %}–õ–µ–≥–∫–∏–π{% elif level == 3 %}–°—Ä–µ–¥–Ω–∏–π{% elif level == 4 %}–°–ª–æ–∂–Ω—ã–π{% else %}–≠–∫—Å–ø–µ—Ä—Ç{% endif %}</span>
                    </div>
                    <div class="cyber-subtext">–ü—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤: {{ score // 15 }}/5</div>
                </div>

                <!-- –°—Ü–µ–Ω–∞—Ä–∏–π -->
                <div class="scenario-container">
                    {{ scenario.scenario|safe }}
                </div>

                <!-- –ü—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ –ø—Ä–∏–µ–º—ã -->
                <div class="psychology-tips">
                    <h5 class="text-warning mb-3">
                        <i class="bi bi-lightbulb me-2"></i>–ü–°–ò–•–û–õ–û–ì–ò–ß–ï–°–ö–ò–ï –ü–†–ò–ï–ú–´ –í –ê–¢–ê–ö–ï:
                    </h5>
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>–°–æ–∑–¥–∞–Ω–∏–µ —Å—Ä–æ—á–Ω–æ—Å—Ç–∏:</strong> "–ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ –Ω—É–∂–Ω–æ –¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å!"</p>
                            <p><strong>–ê–≤—Ç–æ—Ä–∏—Ç–µ—Ç:</strong> "–Ø –∏–∑ —Å–ª—É–∂–±—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏..."</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>–°–æ—Ü–∏–∞–ª—å–Ω–æ–µ –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–æ:</strong> "–í—Å–µ —Ç–∞–∫ –¥–µ–ª–∞—é—Ç"</p>
                            <p><strong>–í–∑–∞–∏–º–Ω–æ—Å—Ç—å:</strong> "–Ø –≤–∞–º –ø–æ–º–æ–≥, —Ç–µ–ø–µ—Ä—å –≤—ã –º–Ω–µ"</p>
                        </div>
                    </div>
                </div>

                <!-- –í–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–æ–≤ -->
                <div class="options-grid">
                    {% for option in scenario.options %}
                    <div class="option-card" onclick="selectOption({{ loop.index0 }})" id="option{{ loop.index0 }}">
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="scenarioOption" 
                                   id="option{{ loop.index0 }}Radio" value="{{ loop.index0 }}">
                            <label class="form-check-label cyber-text" for="option{{ loop.index0 }}Radio">
                                {{ option }}
                            </label>
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <!-- –ö–Ω–æ–ø–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ -->
                <div class="text-center">
                    <button id="checkBtn" class="btn btn-cyber btn-lg" onclick="checkAnswer()" disabled>
                        <i class="bi bi-check-circle me-2"></i>–ü–†–û–í–ï–†–ò–¢–¨ –û–¢–í–ï–¢
                    </button>
                </div>

                <!-- –ê–Ω–∞–ª–∏–∑ -->
                <div id="analysis" class="analysis-box" style="display: none;">
                    <h4 class="cyber-text mb-3">
                        <i class="bi bi-search me-2"></i>–ê–ù–ê–õ–ò–ó –°–ò–¢–£–ê–¶–ò–ò
                    </h4>
                    <p id="analysis-text" class="mb-3"></p>
                    <div class="text-center">
                        <button id="nextBtn" class="btn btn-cyber" onclick="nextScenario()">
                            <i class="bi bi-arrow-right me-2"></i>–°–õ–ï–î–£–Æ–©–ò–ô –°–¶–ï–ù–ê–†–ò–ô
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let selectedOption = null;

function selectOption(optionIndex) {
    selectedOption = optionIndex;
    
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ
    document.querySelectorAll('.option-card').forEach(card => {
        card.classList.remove('selected');
    });
    
    // –í—ã–¥–µ–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç
    document.getElementById(`option${optionIndex}`).classList.add('selected');
    document.getElementById(`option${optionIndex}Radio`).checked = true;
    
    // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –ø—Ä–æ–≤–µ—Ä–∫–∏
    document.getElementById('checkBtn').disabled = false;
}

function checkAnswer() {
    if (selectedOption === null) return;
    
    const checkBtn = document.getElementById('checkBtn');
    checkBtn.disabled = true;
    checkBtn.innerHTML = '<div class="spinner-border spinner-border-sm me-2"></div>–ü–†–û–í–ï–†–Ø–ï–ú...';
    
    fetch('/simulators/check-social', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            level: {{ level }},
            answer: selectedOption
        })
    })
    .then(response => response.json())
    .then(data => {
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π/–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç
        document.querySelectorAll('.option-card').forEach((card, index) => {
            if (index === {{ scenario.correct_answer }}) {
                card.style.borderColor = 'var(--cyber-primary)';
                card.style.background = 'rgba(0, 255, 136, 0.2)';
            } else if (index === selectedOption && !data.correct) {
                card.style.borderColor = '#ff4444';
                card.style.background = 'rgba(255, 68, 68, 0.2)';
            }
        });
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–Ω–∞–ª–∏–∑
        document.getElementById('analysis-text').textContent = data.explanation;
        document.getElementById('analysis').style.display = 'block';
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É
        if (data.correct) {
            showNotification('‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ! +15 –æ—á–∫–æ–≤', 'success');
            checkBtn.innerHTML = '<i class="bi bi-check-circle me-2"></i>–í–ï–†–ù–û!';
        } else {
            showNotification('‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ! –ò–∑—É—á–∏—Ç–µ –∞–Ω–∞–ª–∏–∑', 'danger');
            checkBtn.innerHTML = '<i class="bi bi-x-circle me-2"></i>–ù–ï–í–ï–†–ù–û';
        }
    });
}

function nextScenario() {
    window.location.reload();
}
</script>
{% endblock %}