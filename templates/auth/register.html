{% extends "base.html" %}

{% block content %}

<style>
    /* –î–æ–±–∞–≤—å—Ç–µ —ç—Ç–æ—Ç —Å—Ç–∏–ª—å */
    body {
        padding-top: 2rem;
    }

    .cyber-icon-large {
        width: 80px;
        height: 80px;
        /* –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ */
    }
</style>

<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="cyber-card p-5">
                <div class="text-center mb-4">
                    <div class="cyber-icon-large">
                        <i class="bi bi-shield-check"></i>
                    </div>
                    <h2 class="cyber-title glow-text mt-3">–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</h2>
                    <p class="cyber-subtext">–ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–π—Ç–µ—Å—å –∫ —Å–æ–æ–±—â–µ—Å—Ç–≤—É –∫–∏–±–µ—Ä–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏</p>
                </div>

                <form method="POST" id="registerForm">
                    <!-- –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
                    <div class="mb-4">
                        <label class="form-label cyber-label">
                            <i class="bi bi-person me-2"></i>–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                        </label>
                        <input type="text" class="form-control cyber-input" name="username" required
                            value="{{ username if username }}" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" minlength="3"
                            id="usernameInput">
                        <div class="form-feedback" id="usernameFeedback"></div>
                    </div>

                    <!-- Email -->
                    <div class="mb-4">
                        <label class="form-label cyber-label">
                            <i class="bi bi-envelope me-2"></i>Email
                        </label>
                        <input type="email" class="form-control cyber-input" name="email" required
                            value="{{ email if email }}" placeholder="–í–≤–µ–¥–∏—Ç–µ email" id="emailInput">
                        <div class="form-feedback" id="emailFeedback"></div>
                    </div>

                    <!-- –ü–∞—Ä–æ–ª—å -->
                    <div class="mb-4">
                        <label class="form-label cyber-label">
                            <i class="bi bi-key me-2"></i>–ü–∞—Ä–æ–ª—å
                        </label>
                        <input type="password" class="form-control cyber-input" name="password" required
                            id="passwordInput" placeholder="–°–æ–∑–¥–∞–π—Ç–µ –ø–∞—Ä–æ–ª—å (–º–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞)" minlength="3">

                        <!-- –ü—Ä–æ—Å—Ç–∞—è –ø–æ–¥—Å–∫–∞–∑–∫–∞ –æ –ø–∞—Ä–æ–ª–µ -->
                        <div class="password-hint mt-2">
                            <small class="form-text text-muted" id="passwordHint">
                                –ú–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞
                            </small>
                        </div>
                    </div>

                    <!-- –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–∞—Ä–æ–ª—è -->
                    <div class="mb-4">
                        <label class="form-label cyber-label">
                            <i class="bi bi-key-fill me-2"></i>–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–∞—Ä–æ–ª—è
                        </label>
                        <input type="password" class="form-control cyber-input" name="confirm_password" required
                            id="confirmPasswordInput" placeholder="–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å" minlength="3">
                        <div class="form-feedback" id="confirmFeedback"></div>
                    </div>

                    <!-- –ö–Ω–æ–ø–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ -->
                    <button type="submit" class="btn btn-cyber w-100 mb-3 py-3" id="submitBtn">
                        <i class="bi bi-shield-check me-2"></i>
                        –°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç
                    </button>

                    <!-- –°—Å—ã–ª–∫–∞ –Ω–∞ –≤—Ö–æ–¥ -->
                    <div class="text-center">
                        <span class="cyber-subtext">–£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? </span>
                        <a href="{{ url_for('auth.login') }}" class="cyber-link">–í–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É</a>
                    </div>
                </form>
            </div>

            <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ -->
            <div class="cyber-card mt-4 p-4">
                <h6 class="cyber-text-bright mb-3">
                    <i class="bi bi-lightning me-2"></i>–°–æ–≤–µ—Ç—ã –ø–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
                </h6>
                <ul class="cyber-list small">
                    <li>–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ä–∞–∑–Ω—ã–µ –ø–∞—Ä–æ–ª–∏ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤</li>
                    <li>–î–ª–∏–Ω–Ω—ã–µ –ø–∞—Ä–æ–ª–∏ –Ω–∞–¥–µ–∂–Ω–µ–µ –∫–æ—Ä–æ—Ç–∫–∏—Ö</li>
                    <li>–ö–æ–º–±–∏–Ω–∞—Ü–∏—è –±—É–∫–≤, —Ü–∏—Ñ—Ä –∏ —Å–∏–º–≤–æ–ª–æ–≤ –ø–æ–≤—ã—à–∞–µ—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å</li>
                    <li>–ù–∏–∫–æ–≥–¥–∞ –Ω–µ —Å–æ–æ–±—â–∞–π—Ç–µ –ø–∞—Ä–æ–ª—å –¥—Ä—É–≥–∏–º –ª—é–¥—è–º</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<style>
    .cyber-icon-large {
        width: 80px;
        height: 80px;
        background: linear-gradient(135deg, var(--cyber-primary), var(--cyber-accent));
        border-radius: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto;
        font-size: 2rem;
        color: white;
    }

    .cyber-label {
        font-weight: 600;
        color: var(--cyber-text-bright);
        margin-bottom: 0.5rem;
    }

    .form-feedback {
        font-size: 0.875rem;
        margin-top: 0.25rem;
        min-height: 1.25rem;
    }

    .password-hint {
        font-size: 0.875rem;
    }

    .cyber-list {
        list-style: none;
        padding-left: 0;
        margin-bottom: 0;
    }

    .cyber-list li {
        padding: 0.25rem 0;
        position: relative;
        padding-left: 1.5rem;
    }

    .cyber-list li:before {
        content: 'üîí';
        position: absolute;
        left: 0;
        font-size: 0.8rem;
    }

    /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
    @media (max-width: 768px) {
        .cyber-card {
            padding: 2rem !important;
        }

        .cyber-icon-large {
            width: 60px;
            height: 60px;
            font-size: 1.5rem;
        }
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const usernameInput = document.getElementById('usernameInput');
        const emailInput = document.getElementById('emailInput');
        const passwordInput = document.getElementById('passwordInput');
        const confirmInput = document.getElementById('confirmPasswordInput');
        const passwordHint = document.getElementById('passwordHint');
        const registerForm = document.getElementById('registerForm');

        const usernameFeedback = document.getElementById('usernameFeedback');
        const emailFeedback = document.getElementById('emailFeedback');
        const confirmFeedback = document.getElementById('confirmFeedback');

        // –î–µ–±–∞—É–Ω—Å –¥–ª—è AJAX –∑–∞–ø—Ä–æ—Å–æ–≤
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–º–µ–Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        const checkUsername = debounce(function () {
            const username = usernameInput.value.trim();

            if (username.length < 3) {
                showFeedback(usernameFeedback, '–ú–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞', 'warning');
                return;
            }

            if (!/^[a-zA-Z0-9_]+$/.test(username)) {
                showFeedback(usernameFeedback, '–¢–æ–ª—å–∫–æ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã –∏ _', 'error');
                return;
            }

            // AJAX –ø—Ä–æ–≤–µ—Ä–∫–∞
            fetch(`/auth/check_username?username=${encodeURIComponent(username)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.available) {
                        showFeedback(usernameFeedback, '‚úì –ò–º—è –¥–æ—Å—Ç—É–ø–Ω–æ', 'success');
                    } else {
                        showFeedback(usernameFeedback, data.message, 'error');
                    }
                });
        }, 500);

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ email
        const checkEmail = debounce(function () {
            const email = emailInput.value.trim();

            if (!email) {
                showFeedback(emailFeedback, '', 'neutral');
                return;
            }

            if (!/^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/.test(email)) {
                showFeedback(emailFeedback, '–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π email', 'error');
                return;
            }

            // AJAX –ø—Ä–æ–≤–µ—Ä–∫–∞
            fetch(`/auth/check_email?email=${encodeURIComponent(email)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.valid) {
                        showFeedback(emailFeedback, '‚úì Email –¥–æ—Å—Ç—É–ø–µ–Ω', 'success');
                    } else {
                        showFeedback(emailFeedback, data.message, 'error');
                    }
                });
        }, 500);

        // –ü—Ä–æ—Å—Ç–∞—è –ø–æ–¥—Å–∫–∞–∑–∫–∞ –æ –ø–∞—Ä–æ–ª–µ
        function updatePasswordHint() {
            const password = passwordInput.value;

            if (!password) {
                passwordHint.textContent = '–ú–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞';
                passwordHint.className = 'form-text text-muted';
            } else if (password.length < 3) {
                passwordHint.textContent = '–ü–∞—Ä–æ–ª—å —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π (–º–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞)';
                passwordHint.className = 'form-text text-warning';
            } else {
                passwordHint.textContent = '‚úì –ü–∞—Ä–æ–ª—å –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ–π –¥–ª–∏–Ω—ã';
                passwordHint.className = 'form-text text-success';
            }
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è –ø–∞—Ä–æ–ª–µ–π
        function checkPasswordMatch() {
            const password = passwordInput.value;
            const confirm = confirmInput.value;

            if (!confirm) {
                showFeedback(confirmFeedback, '', 'neutral');
                return;
            }

            if (password === confirm) {
                showFeedback(confirmFeedback, '‚úì –ü–∞—Ä–æ–ª–∏ —Å–æ–≤–ø–∞–¥–∞—é—Ç', 'success');
            } else {
                showFeedback(confirmFeedback, '‚úó –ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç', 'error');
            }
        }

        // –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏
        function showFeedback(element, message, type) {
            element.textContent = message;
            element.className = 'form-feedback';

            switch (type) {
                case 'success':
                    element.classList.add('text-success');
                    break;
                case 'warning':
                    element.classList.add('text-warning');
                    break;
                case 'error':
                    element.classList.add('text-danger');
                    break;
                case 'neutral':
                    element.classList.add('text-muted');
                    break;
            }
        }

        // –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ä–º—ã –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
        registerForm.addEventListener('submit', function (e) {
            const username = usernameInput.value.trim();
            const email = emailInput.value.trim();
            const password = passwordInput.value;
            const confirm = confirmInput.value;

            let hasErrors = false;

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–º–µ–Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            if (username.length < 3) {
                showFeedback(usernameFeedback, '–ú–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞', 'error');
                hasErrors = true;
            }

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ email
            if (!/^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/.test(email)) {
                showFeedback(emailFeedback, '–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π email', 'error');
                hasErrors = true;
            }

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞—Ä–æ–ª—è
            if (password.length < 3) {
                showFeedback(confirmFeedback, '–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞', 'error');
                hasErrors = true;
            } else if (password !== confirm) {
                showFeedback(confirmFeedback, '–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç', 'error');
                hasErrors = true;
            }

            if (hasErrors) {
                e.preventDefault();
                return false;
            }
        });

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
        usernameInput.addEventListener('input', checkUsername);
        emailInput.addEventListener('input', checkEmail);
        passwordInput.addEventListener('input', updatePasswordHint);
        confirmInput.addEventListener('input', checkPasswordMatch);

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        checkUsername();
        checkEmail();
        updatePasswordHint();
    });
</script>
{% endblock %}