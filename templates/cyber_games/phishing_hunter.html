{% extends "base.html" %}

{% block title %}Охотник за фишингом - CyberGuardian{% endblock %}

{% block extra_css %}
<style>
.email-container {
    background: rgba(20, 20, 20, 0.9);
    border: 2px solid var(--cyber-border);
    border-radius: 15px;
    padding: 2rem;
    margin: 2rem 0;
    min-height: 400px;
}

.email-header {
    border-bottom: 1px solid var(--cyber-border);
    padding-bottom: 1rem;
    margin-bottom: 1.5rem;
}

.email-sender {
    font-weight: bold;
    color: var(--cyber-primary);
}

.email-subject {
    font-size: 1.2rem;
    font-weight: bold;
    margin: 0.5rem 0;
}

.email-content {
    white-space: pre-line;
    line-height: 1.6;
    margin-bottom: 2rem;
}

.verdict-buttons {
    display: flex;
    gap: 1rem;
    justify-content: center;
    margin: 2rem 0;
}

.verdict-btn {
    padding: 1rem 2rem;
    font-size: 1.1rem;
    font-weight: bold;
    border: 2px solid;
    border-radius: 10px;
    transition: all 0.3s ease;
    cursor: pointer;
}

.btn-phishing {
    background: rgba(220, 53, 69, 0.1);
    border-color: #dc3545;
    color: #dc3545;
}

.btn-phishing:hover {
    background: #dc3545;
    color: white;
}

.btn-legitimate {
    background: rgba(40, 167, 69, 0.1);
    border-color: #28a745;
    color: #28a745;
}

.btn-legitimate:hover {
    background: #28a745;
    color: white;
}

.clues-container {
    background: rgba(30, 30, 30, 0.8);
    border: 1px solid var(--cyber-border);
    border-radius: 10px;
    padding: 1.5rem;
    margin-top: 2rem;
}

.clue-item {
    padding: 0.5rem 0;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.clue-item:last-child {
    border-bottom: none;
}

.progress-container {
    background: rgba(30, 30, 30, 0.8);
    border-radius: 10px;
    padding: 1rem;
    margin-bottom: 2rem;
}

.score-display {
    font-size: 1.5rem;
    font-weight: bold;
    text-align: center;
    margin: 1rem 0;
}

.game-feedback {
    padding: 1rem;
    border-radius: 10px;
    margin: 1rem 0;
    text-align: center;
    font-weight: bold;
}

.feedback-correct {
    background: rgba(40, 167, 69, 0.2);
    border: 1px solid #28a745;
    color: #28a745;
}

.feedback-incorrect {
    background: rgba(220, 53, 69, 0.2);
    border: 1px solid #dc3545;
    color: #dc3545;
}

.suspicious-link {
    color: #ff6b6b;
    font-weight: bold;
}

.suspicious-domain {
    background: rgba(220, 53, 69, 0.2);
    padding: 0.2rem 0.5rem;
    border-radius: 4px;
}
</style>
{% endblock %}

{% block content %}
<div class="container">
    <!-- Заголовок -->
    <div class="row mb-4">
        <div class="col-12 text-center">
            <h1 class="cyber-text glow-text mb-3">
                <i class="bi bi-envelope-exclamation me-2"></i>Охотник за фишингом
            </h1>
            <p class="cyber-subtext lead">
                Научитесь распознавать мошеннические письма и защитите себя от фишинговых атак!
            </p>
        </div>
    </div>

    <!-- Прогресс и счет -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="progress-container">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h4 class="cyber-text mb-1">Текущий раунд</h4>
                        <div class="cyber-subtext" id="roundInfo">Email 1 из 4</div>
                    </div>
                    <div class="text-center">
                        <div class="cyber-subtext">Счет</div>
                        <div class="score-display text-cyber-primary" id="currentScore">0</div>
                    </div>
                    <div class="text-end">
                        <h4 class="cyber-text mb-1">Правильных ответов</h4>
                        <div class="cyber-subtext" id="correctAnswers">0/0</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Контейнер для email -->
    <div class="row">
        <div class="col-12">
            <div class="email-container" id="emailContainer">
                <div class="text-center cyber-subtext">
                    <i class="bi bi-hourglass-split display-4"></i>
                    <p class="mt-3">Загрузка письма...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Кнопки вердикта -->
    <div class="row" id="verdictSection" style="display: none;">
        <div class="col-12">
            <div class="verdict-buttons">
                <button class="btn btn-phishing verdict-btn" onclick="makeVerdict(true)">
                    <i class="bi bi-exclamation-triangle me-2"></i>ФИШИНГ
                </button>
                <button class="btn btn-legitimate verdict-btn" onclick="makeVerdict(false)">
                    <i class="bi bi-shield-check me-2"></i>НАДЕЖНЫЙ
                </button>
            </div>
        </div>
    </div>

    <!-- Результат -->
    <div class="row">
        <div class="col-12">
            <div id="resultSection" style="display: none;">
                <div class="game-feedback" id="feedbackMessage"></div>
                <div class="clues-container" id="cluesContainer"></div>
                <div class="text-center mt-4">
                    <button class="btn btn-cyber btn-lg" onclick="loadNextEmail()" id="nextButton">
                        <i class="bi bi-arrow-right me-2"></i>Следующий email
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Статистика игры -->
    <div class="row mt-5">
        <div class="col-12">
            <div class="cyber-card p-4">
                <h4 class="cyber-text mb-3">
                    <i class="bi bi-info-circle me-2"></i>Как распознать фишинг?
                </h4>
                <div class="row">
                    <div class="col-md-6">
                        <ul class="cyber-subtext">
                            <li>Проверяйте адрес отправителя</li>
                            <li>Обращайте внимание на грамматические ошибки</li>
                            <li>Не переходите по подозрительным ссылкам</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <ul class="cyber-subtext">
                            <li>Остерегайтесь искусственной срочности</li>
                            <li>Проверяйте домены сайтов</li>
                            <li>Не скачивайте вложения из непроверенных писем</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentEmails = [];
let currentEmailIndex = 0;
let totalScore = 0;
let correctAnswers = 0;
let totalEmails = 0;

// Загрузка emails
async function loadEmails() {
    try {
        const response = await fetch('/games/api/games/phishing/emails');
        const data = await response.json();
        currentEmails = data.emails;
        totalEmails = currentEmails.length;
        currentEmailIndex = 0;
        
        displayCurrentEmail();
        updateProgress();
        
        // Показываем кнопки вердикта
        document.getElementById('verdictSection').style.display = 'block';
    } catch (error) {
        console.error('Ошибка загрузки emails:', error);
        showError('Не удалось загрузить письма');
    }
}

// Отображение текущего email
function displayCurrentEmail() {
    if (currentEmailIndex >= currentEmails.length) {
        endGame();
        return;
    }
    
    const email = currentEmails[currentEmailIndex];
    const container = document.getElementById('emailContainer');
    
    // Подсветка подозрительных элементов
    let content = email.content;
    content = content.replace(/(http[^\s]+)/g, '<span class="suspicious-link">$1</span>');
    
    container.innerHTML = `
        <div class="email-header">
            <div class="email-sender">От: ${email.sender}</div>
            <div class="email-subject">${email.subject}</div>
            <div class="cyber-subtext">${new Date().toLocaleString()}</div>
        </div>
        <div class="email-content">${content}</div>
    `;
    
    // Скрываем результат предыдущего раунда
    document.getElementById('resultSection').style.display = 'none';
    document.getElementById('verdictSection').style.display = 'block';
    
    updateProgress();
}

// Сделать вердикт
async function makeVerdict(isPhishing) {
    const email = currentEmails[currentEmailIndex];
    
    try {
        const response = await fetch('/games/api/games/phishing/check', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                email_id: email.id,
                is_phishing: isPhishing
            })
        });
        
        const result = await response.json();
        
        // Обновляем счет
        if (result.correct) {
            totalScore += result.score;
            correctAnswers++;
        }
        
        // Показываем результат
        showResult(result, email);
        
    } catch (error) {
        console.error('Ошибка проверки:', error);
        showError('Ошибка проверки ответа');
    }
}

// Показать результат
function showResult(result, email) {
    const feedback = document.getElementById('feedbackMessage');
    const cluesContainer = document.getElementById('cluesContainer');
    
    // Обратная связь
    if (result.correct) {
        feedback.className = 'game-feedback feedback-correct';
        feedback.innerHTML = `<i class="bi bi-check-circle me-2"></i>Правильно! +${result.score} очков`;
    } else {
        feedback.className = 'game-feedback feedback-incorrect';
        const correctType = email.is_phishing ? 'ФИШИНГ' : 'НАДЕЖНЫЙ';
        feedback.innerHTML = `<i class="bi bi-x-circle me-2"></i>Неправильно! Это был ${correctType}`;
    }
    
    // Подсказки
    cluesContainer.innerHTML = `
        <h5 class="cyber-text mb-3">${email.is_phishing ? 'Признаки фишинга:' : 'Признаки надежного письма:'}</h5>
        ${result.explanation.map(clue => `
            <div class="clue-item">
                <i class="bi bi-arrow-right-short text-cyber-primary me-2"></i>
                ${clue}
            </div>
        `).join('')}
    `;
    
    // Показываем результат и скрываем кнопки вердикта
    document.getElementById('resultSection').style.display = 'block';
    document.getElementById('verdictSection').style.display = 'none';
    
    // Обновляем счет
    updateScore();
}

// Загрузить следующий email
function loadNextEmail() {
    currentEmailIndex++;
    if (currentEmailIndex < currentEmails.length) {
        displayCurrentEmail();
    } else {
        endGame();
    }
}

// Обновить прогресс
function updateProgress() {
    document.getElementById('roundInfo').textContent = `Email ${currentEmailIndex + 1} из ${totalEmails}`;
    document.getElementById('correctAnswers').textContent = `${correctAnswers}/${currentEmailIndex}`;
}

// Обновить счет
function updateScore() {
    document.getElementById('currentScore').textContent = totalScore;
}

// Завершить игру
function endGame() {
    const container = document.getElementById('emailContainer');
    container.innerHTML = `
        <div class="text-center">
            <i class="bi bi-trophy display-1 text-warning mb-3"></i>
            <h3 class="cyber-text mb-3">Игра завершена!</h3>
            <p class="cyber-subtext lead">Ваш результат: ${totalScore} очков</p>
            <p class="cyber-subtext">Правильных ответов: ${correctAnswers} из ${totalEmails}</p>
            <div class="mt-4">
                <button class="btn btn-cyber me-3" onclick="loadEmails()">
                    <i class="bi bi-arrow-repeat me-2"></i>Играть снова
                </button>
                <a href="{{ url_for('games.games_dashboard') }}" class="btn btn-outline-cyber">
                    <i class="bi bi-house me-2"></i>На главную
                </a>
            </div>
        </div>
    `;
    
    document.getElementById('verdictSection').style.display = 'none';
    document.getElementById('resultSection').style.display = 'none';
}

// Показать ошибку
function showError(message) {
    const container = document.getElementById('emailContainer');
    container.innerHTML = `
        <div class="text-center text-danger">
            <i class="bi bi-exclamation-triangle display-4"></i>
            <p class="mt-3">${message}</p>
            <button class="btn btn-cyber mt-2" onclick="loadEmails()">
                <i class="bi bi-arrow-repeat me-2"></i>Попробовать снова
            </button>
        </div>
    `;
}

// Запуск игры при загрузке страницы
document.addEventListener('DOMContentLoaded', loadEmails);
</script>
{% endblock %}
