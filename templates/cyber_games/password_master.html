{% extends "base.html" %}

{% block title %}Мастер паролей - CyberGuardian{% endblock %}

{% block extra_css %}
<style>
.password-card {
    background: rgba(20, 20, 20, 0.9);
    border: 2px solid var(--cyber-border);
    border-radius: 15px;
    padding: 2rem;
    margin: 1rem 0;
    transition: all 0.3s ease;
}

.password-display {
    font-family: 'Courier New', monospace;
    font-size: 1.5rem;
    font-weight: bold;
    text-align: center;
    padding: 1rem;
    background: rgba(30, 30, 30, 0.8);
    border-radius: 10px;
    margin: 1rem 0;
    border: 1px solid var(--cyber-border);
    letter-spacing: 2px;
    word-break: break-all;
}

.strength-slider {
    width: 100%;
    margin: 2rem 0;
    background: transparent;
}

.strength-meter {
    height: 20px;
    border-radius: 10px;
    background: linear-gradient(90deg, 
        #dc3545 0%, 
        #fd7e14 25%, 
        #ffc107 50%, 
        #20c997 75%, 
        #198754 100%);
    margin: 1rem 0;
    position: relative;
    overflow: hidden;
}

.strength-indicator {
    position: absolute;
    top: -5px;
    width: 10px;
    height: 30px;
    background: white;
    border-radius: 5px;
    transition: left 0.3s ease;
    box-shadow: 0 0 10px rgba(255, 255, 255, 0.8);
    z-index: 2;
}

.strength-labels {
    display: flex;
    justify-content: space-between;
    margin-top: 0.5rem;
    font-size: 0.8rem;
    color: var(--cyber-subtext);
}

.feedback-container {
    background: rgba(30, 30, 30, 0.8);
    border: 1px solid var(--cyber-border);
    border-radius: 10px;
    padding: 1.5rem;
    margin: 1rem 0;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin: 2rem 0;
}

.stat-card {
    background: rgba(30, 30, 30, 0.8);
    border: 1px solid var(--cyber-border);
    border-radius: 10px;
    padding: 1.5rem;
    text-align: center;
    transition: all 0.3s ease;
}

.stat-card:hover {
    border-color: var(--cyber-primary);
    transform: translateY(-2px);
}

.stat-value {
    font-size: 2rem;
    font-weight: bold;
    color: var(--cyber-primary);
}

.stat-label {
    font-size: 0.9rem;
    color: var(--cyber-subtext);
}

.learning-section {
    background: rgba(20, 20, 20, 0.9);
    border: 2px solid var(--cyber-border);
    border-radius: 15px;
    padding: 2rem;
    margin: 2rem 0;
}

.tip-card {
    background: rgba(30, 30, 30, 0.8);
    border: 1px solid var(--cyber-border);
    border-radius: 10px;
    padding: 1.5rem;
    margin: 1rem 0;
    transition: all 0.3s ease;
}

.tip-card:hover {
    border-color: var(--cyber-primary);
    transform: translateX(5px);
}

.tip-card.critical {
    border-left: 4px solid #dc3545;
}

.tip-card.high {
    border-left: 4px solid #fd7e14;
}

.tip-card.medium {
    border-left: 4px solid #ffc107;
}

.tip-icon {
    font-size: 2rem;
    margin-right: 1rem;
    color: var(--cyber-primary);
}

.cracking-method {
    background: rgba(40, 40, 40, 0.8);
    border: 1px solid var(--cyber-border);
    border-radius: 10px;
    padding: 1.5rem;
    margin: 1rem 0;
}

.method-header {
    display: flex;
    justify-content: between;
    align-items: center;
    margin-bottom: 1rem;
}

.method-speed {
    background: var(--cyber-accent);
    color: white;
    padding: 0.3rem 0.8rem;
    border-radius: 15px;
    font-size: 0.8rem;
    font-weight: bold;
}

.progress-container {
    background: rgba(30, 30, 30, 0.8);
    border-radius: 10px;
    padding: 1rem;
    margin-bottom: 2rem;
}

.quiz-section {
    background: rgba(20, 20, 20, 0.9);
    border: 2px solid var(--cyber-border);
    border-radius: 15px;
    padding: 2rem;
    margin: 2rem 0;
}

.quiz-question {
    background: rgba(30, 30, 30, 0.8);
    border-radius: 10px;
    padding: 1.5rem;
    margin: 1rem 0;
}

.quiz-option {
    background: rgba(40, 40, 40, 0.8);
    border: 1px solid var(--cyber-border);
    border-radius: 8px;
    padding: 1rem;
    margin: 0.5rem 0;
    cursor: pointer;
    transition: all 0.3s ease;
}

.quiz-option:hover {
    background: rgba(60, 60, 60, 0.8);
    border-color: var(--cyber-primary);
}

.quiz-option.selected {
    background: rgba(var(--cyber-primary-rgb), 0.2);
    border-color: var(--cyber-primary);
}

.password-analysis {
    background: rgba(30, 30, 30, 0.8);
    border-radius: 10px;
    padding: 1.5rem;
    margin: 1rem 0;
}

.analysis-item {
    display: flex;
    justify-content: space-between;
    padding: 0.5rem 0;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.analysis-item:last-child {
    border-bottom: none;
}

.analysis-good {
    color: #28a745;
}

.analysis-bad {
    color: #dc3545;
}

.analysis-neutral {
    color: #ffc107;
}
</style>
{% endblock %}

{% block content %}
<div class="container">
    <!-- Заголовок -->
    <div class="row mb-4">
        <div class="col-12 text-center">
            <h1 class="cyber-text glow-text mb-3">
                <i class="bi bi-shield-lock me-2"></i>Мастер паролей
            </h1>
            <p class="cyber-subtext lead">
                Научитесь оценивать надежность паролей и защитите свои аккаунты!
            </p>
        </div>
    </div>

    <!-- Прогресс и статистика -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="progress-container">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h4 class="cyber-text mb-0">Текущая сессия</h4>
                    <div class="cyber-subtext" id="sessionInfo">Пароль 1 из 10</div>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                </div>
                <div class="stats-grid mt-3">
                    <div class="stat-card">
                        <div class="stat-value" id="currentScore">0</div>
                        <div class="stat-label">Текущий счет</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="correctAnswers">0</div>
                        <div class="stat-label">Правильных ответов</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="averageAccuracy">0%</div>
                        <div class="stat-label">Средняя точность</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="gamesPlayed">0</div>
                        <div class="stat-label">Сыграно игр</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Основная игра -->
        <div class="col-lg-8">
            <div class="password-card">
                <h3 class="cyber-text mb-4 text-center">
                    <i class="bi bi-speedometer2 me-2"></i>Оцените надежность пароля
                </h3>
                
                <div id="gameSection">
                    <div class="password-display" id="currentPassword">
                        Загрузка паролей...
                    </div>
                    
                    <div class="strength-meter">
                        <div class="strength-indicator" id="strengthIndicator" style="left: 0%;"></div>
                    </div>
                    
                    <div class="strength-labels">
                        <span>Очень слабый</span>
                        <span>Средний</span>
                        <span>Очень надежный</span>
                    </div>
                    
                    <input type="range" class="strength-slider" id="strengthSlider" 
                           min="0" max="100" value="50" step="1">
                    
                    <div class="text-center mb-3">
                        <span class="cyber-subtext">Ваша оценка: </span>
                        <span class="cyber-text" id="userStrengthValue">50</span>
                        <span class="cyber-subtext">/100</span>
                    </div>
                    
                    <div class="text-center">
                        <button class="btn btn-cyber btn-lg" onclick="checkPassword()" id="checkButton">
                            <i class="bi bi-check-circle me-2"></i>Проверить оценку
                        </button>
                    </div>
                </div>
                
                <div id="resultSection" style="display: none;">
                    <div class="feedback-container">
                        <h5 class="cyber-text mb-3">
                            <i class="bi bi-graph-up me-2"></i>Результат анализа
                        </h5>
                        <div id="resultContent"></div>
                    </div>
                    <div class="text-center mt-3">
                        <button class="btn btn-cyber btn-lg" onclick="nextPassword()" id="nextButton">
                            <i class="bi bi-arrow-right me-2"></i>Следующий пароль
                        </button>
                    </div>
                </div>
            </div>

            <!-- Анализ пароля -->
            <div class="password-analysis" id="analysisSection" style="display: none;">
                <h5 class="cyber-text mb-3">
                    <i class="bi bi-search me-2"></i>Детальный анализ
                </h5>
                <div id="analysisContent"></div>
            </div>

            <!-- Методы взлома -->
            <div class="learning-section">
                <h3 class="cyber-text mb-4">
                    <i class="bi bi-shield-exclamation me-2"></i>Как взламывают пароли?
                </h3>
                <div id="crackingMethods">
                    <!-- Методы будут загружены через JS -->
                </div>
            </div>
        </div>

        <!-- Обучающие материалы -->
        <div class="col-lg-4">
            <!-- Советы по безопасности -->
            <div class="learning-section">
                <h4 class="cyber-text mb-3">
                    <i class="bi bi-lightbulb me-2"></i>Золотые правила паролей
                </h4>
                <div id="securityTips">
                    <!-- Советы будут загружены через JS -->
                </div>
            </div>

            <!-- Мини-квиз -->
            <div class="quiz-section">
                <h4 class="cyber-text mb-3">
                    <i class="bi bi-patch-question me-2"></i>Проверь знания
                </h4>
                <div class="quiz-question">
                    <p class="cyber-text mb-3">Какой пароль самый надежный?</p>
                    <div class="quiz-option" onclick="selectQuizOption(0)">A. 123456</div>
                    <div class="quiz-option" onclick="selectQuizOption(1)">B. Password2024!</div>
                    <div class="quiz-option" onclick="selectQuizOption(2)">C. Xk8&zQ2#pL9$mN5*</div>
                    <div class="quiz-option" onclick="selectQuizOption(3)">D. IloveMyCat123</div>
                </div>
                <button class="btn btn-cyber w-100" onclick="checkQuizAnswer()" id="quizButton">
                    Проверить ответ
                </button>
                <div id="quizResult" class="mt-3" style="display: none;"></div>
            </div>

            <!-- Шкала времени взлома -->
            <div class="learning-section">
                <h4 class="cyber-text mb-3">
                    <i class="bi bi-clock me-2"></i>Время взлома паролей
                </h4>
                <div class="tip-card">
                    <h6 class="cyber-text">🔓 Простые пароли (6 символов)</h6>
                    <p class="cyber-subtext small mb-2">Мгновенно - несколько секунд</p>
                    <div class="progress" style="height: 8px;">
                        <div class="progress-bar bg-danger" style="width: 100%"></div>
                    </div>
                </div>
                <div class="tip-card">
                    <h6 class="cyber-text">🔐 Средние пароли (8-10 символов)</h6>
                    <p class="cyber-subtext small mb-2">Минуты - несколько дней</p>
                    <div class="progress" style="height: 8px;">
                        <div class="progress-bar bg-warning" style="width: 70%"></div>
                    </div>
                </div>
                <div class="tip-card">
                    <h6 class="cyber-text">🔒 Сложные пароли (12+ символов)</h6>
                    <p class="cyber-subtext small mb-2">Годы - столетия</p>
                    <div class="progress" style="height: 8px;">
                        <div class="progress-bar bg-success" style="width: 30%"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentPasswords = [];
let currentPasswordIndex = 0;
let gameStats = {
    played: 0,
    totalScore: 0,
    roundsPlayed: 0,
    correctAnswers: 0,
    totalRounds: 0
};
let securityTips = [];
let crackingMethods = [];

// Загрузка данных
async function loadGameData() {
    try {
        await Promise.all([
            loadPasswords(),
            loadSecurityTips(),
            loadCrackingMethods()
        ]);
    } catch (error) {
        console.error('Ошибка загрузки данных:', error);
        showError('Не удалось загрузить данные игры');
    }
}

// Загрузка паролей для игры
async function loadPasswords() {
    const response = await fetch('/games/api/games/password/strength');
    const data = await response.json();
    currentPasswords = data.passwords;
    currentPasswordIndex = 0;
    gameStats.totalRounds = currentPasswords.length;
    displayCurrentPassword();
    updateStats();
}

// Загрузка советов по безопасности
async function loadSecurityTips() {
    // В реальном приложении это бы приходило с сервера
    securityTips = [
        {
            'title': 'Длина важнее сложности',
            'content': 'Пароль из 12+ случайных символов надежнее короткого сложного пароля.',
            'icon': 'bi-arrows-expand',
            'importance': 'high'
        },
        {
            'title': 'Не повторяйте пароли',
            'content': 'Используйте уникальные пароли для каждого сервиса.',
            'icon': 'bi-shield-check',
            'importance': 'critical'
        },
        {
            'title': 'Избегайте личной информации',
            'content': 'Не используйте имена, даты рождения или другую личную информацию.',
            'icon': 'bi-person-x',
            'importance': 'high'
        }
    ];
    displaySecurityTips();
}

// Загрузка методов взлома
async function loadCrackingMethods() {
    // В реальном приложении это бы приходило с сервера
    crackingMethods = [
        {
            'name': 'Перебор по словарю',
            'description': 'Проверка против списка популярных паролей и слов из словаря.',
            'speed': 'Очень быстро',
            'protection': 'Используйте случайные комбинации'
        },
        {
            'name': 'Брутфорс-атака',
            'description': 'Полный перебор всех возможных комбинаций символов.',
            'speed': 'Медленно для длинных паролей',
            'protection': 'Пароли 12+ символов с разными типами'
        }
    ];
    displayCrackingMethods();
}

// Отображение текущего пароля
function displayCurrentPassword() {
    if (currentPasswordIndex >= currentPasswords.length) {
        endGame();
        return;
    }
    
    const password = currentPasswords[currentPasswordIndex];
    document.getElementById('currentPassword').textContent = password.password;
    document.getElementById('strengthSlider').value = 50;
    updateStrengthIndicator(50);
    
    // Показываем игровую секцию, скрываем результат и анализ
    document.getElementById('gameSection').style.display = 'block';
    document.getElementById('resultSection').style.display = 'none';
    document.getElementById('analysisSection').style.display = 'none';
    
    updateProgress();
}

// Обновление индикатора силы
function updateStrengthIndicator(value) {
    const indicator = document.getElementById('strengthIndicator');
    indicator.style.left = value + '%';
    document.getElementById('userStrengthValue').textContent = value;
}

// Проверить пароль
async function checkPassword() {
    const password = currentPasswords[currentPasswordIndex];
    const userStrength = parseInt(document.getElementById('strengthSlider').value);
    
    try {
        const response = await fetch('/games/api/games/password/check', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                password: password.password,
                strength: userStrength
            })
        });
        
        const result = await response.json();
        showResult(result, password);
        
        // Обновляем статистику
        gameStats.played++;
        gameStats.roundsPlayed++;
        gameStats.totalScore += result.score;
        if (result.score >= 80) gameStats.correctAnswers++;
        updateStats();
        
    } catch (error) {
        console.error('Ошибка проверки:', error);
        showError('Ошибка проверки пароля');
    }
}

// Показать результат
function showResult(result, password) {
    const resultContent = document.getElementById('resultContent');
    const analysisContent = document.getElementById('analysisContent');
    
    // Основной результат
    resultContent.innerHTML = `
        <div class="mb-3">
            <div class="analysis-item">
                <span>Ваша оценка:</span>
                <span class="cyber-text">${result.user_strength}/100</span>
            </div>
            <div class="analysis-item">
                <span>Реальная надежность:</span>
                <span class="cyber-text">${result.actual_strength}/100</span>
            </div>
            <div class="analysis-item">
                <span>Точность оценки:</span>
                <span class="${result.score >= 80 ? 'analysis-good' : result.score >= 60 ? 'analysis-neutral' : 'analysis-bad'}">
                    ${result.accuracy}
                </span>
            </div>
            <div class="analysis-item">
                <span>Время взлома:</span>
                <span class="cyber-text">${result.time_to_crack}</span>
            </div>
        </div>
        <div class="alert ${result.score >= 80 ? 'alert-success' : result.score >= 60 ? 'alert-warning' : 'alert-danger'}">
            <strong>${result.feedback}</strong><br>
            <small>Получено очков: <strong>${result.score}</strong></small>
        </div>
    `;
    
    // Детальный анализ
    analysisContent.innerHTML = `
        <div class="analysis-item">
            <span>Длина пароля:</span>
            <span class="${password.password.length >= 12 ? 'analysis-good' : 'analysis-bad'}">
                ${password.password.length} символов
            </span>
        </div>
        <div class="analysis-item">
            <span>Разнообразие символов:</span>
            <span class="${hasCharacterVariety(password.password) ? 'analysis-good' : 'analysis-bad'}">
                ${getCharacterVarietyText(password.password)}
            </span>
        </div>
        <div class="analysis-item">
            <span>Случайность:</span>
            <span class="${isRandom(password.password) ? 'analysis-good' : 'analysis-bad'}">
                ${isRandom(password.password) ? 'Высокая' : 'Низкая'}
            </span>
        </div>
    `;
    
    document.getElementById('gameSection').style.display = 'none';
    document.getElementById('resultSection').style.display = 'block';
    document.getElementById('analysisSection').style.display = 'block';
}

// Вспомогательные функции для анализа
function hasCharacterVariety(password) {
    const hasUpper = /[A-Z]/.test(password);
    const hasLower = /[a-z]/.test(password);
    const hasNumber = /[0-9]/.test(password);
    const hasSpecial = /[^A-Za-z0-9]/.test(password);
    
    let varietyCount = 0;
    if (hasUpper) varietyCount++;
    if (hasLower) varietyCount++;
    if (hasNumber) varietyCount++;
    if (hasSpecial) varietyCount++;
    
    return varietyCount >= 3;
}

function getCharacterVarietyText(password) {
    const types = [];
    if (/[A-Z]/.test(password)) types.push('A-Z');
    if (/[a-z]/.test(password)) types.push('a-z');
    if (/[0-9]/.test(password)) types.push('0-9');
    if (/[^A-Za-z0-9]/.test(password)) types.push('спец.');
    
    return types.join(', ');
}

function isRandom(password) {
    // Простая проверка на предсказуемость
    const commonPatterns = [
        '123', 'abc', 'qwe', 'password', 'admin', '2024', '2023'
    ];
    
    return !commonPatterns.some(pattern => 
        password.toLowerCase().includes(pattern)
    );
}

// Следующий пароль
function nextPassword() {
    currentPasswordIndex++;
    displayCurrentPassword();
}

// Завершить игру
function endGame() {
    document.getElementById('gameSection').innerHTML = `
        <div class="text-center">
            <i class="bi bi-trophy display-1 text-warning mb-3"></i>
            <h4 class="cyber-text mb-3">Сессия завершена!</h4>
            <p class="cyber-subtext">Проанализировано паролей: ${gameStats.roundsPlayed}</p>
            <p class="cyber-subtext">Общий счет: ${gameStats.totalScore}</p>
            <p class="cyber-subtext">Точность: ${Math.round((gameStats.correctAnswers / gameStats.roundsPlayed) * 100)}%</p>
            <button class="btn btn-cyber mt-2" onclick="loadPasswords()">
                <i class="bi bi-arrow-repeat me-2"></i>Начать новую сессию
            </button>
        </div>
    `;
    document.getElementById('resultSection').style.display = 'none';
    document.getElementById('analysisSection').style.display = 'none';
}

// Обновить статистику
function updateStats() {
    document.getElementById('gamesPlayed').textContent = gameStats.played;
    document.getElementById('currentScore').textContent = gameStats.totalScore;
    document.getElementById('correctAnswers').textContent = gameStats.correctAnswers;
    document.getElementById('averageAccuracy').textContent = gameStats.roundsPlayed > 0 ? 
        Math.round((gameStats.correctAnswers / gameStats.roundsPlayed) * 100) + '%' : '0%';
}

// Обновить прогресс
function updateProgress() {
    const progress = (currentPasswordIndex / currentPasswords.length) * 100;
    document.getElementById('progressFill').style.width = progress + '%';
    document.getElementById('sessionInfo').textContent = 
        `Пароль ${currentPasswordIndex + 1} из ${currentPasswords.length}`;
}

// Отображение советов по безопасности
function displaySecurityTips() {
    const tipsContainer = document.getElementById('securityTips');
    tipsContainer.innerHTML = securityTips.map(tip => `
        <div class="tip-card ${tip.importance}">
            <div class="d-flex align-items-start">
                <i class="${tip.icon} tip-icon"></i>
                <div>
                    <h6 class="cyber-text mb-2">${tip.title}</h6>
                    <p class="cyber-subtext small mb-0">${tip.content}</p>
                </div>
            </div>
        </div>
    `).join('');
}

// Отображение методов взлома
function displayCrackingMethods() {
    const methodsContainer = document.getElementById('crackingMethods');
    methodsContainer.innerHTML = crackingMethods.map(method => `
        <div class="cracking-method">
            <div class="method-header">
                <h6 class="cyber-text mb-0">${method.name}</h6>
                <span class="method-speed">${method.speed}</span>
            </div>
            <p class="cyber-subtext small mb-2">${method.description}</p>
            <div class="cyber-subtext smaller">
                <strong>Защита:</strong> ${method.protection}
            </div>
        </div>
    `).join('');
}

// Мини-квиз
let selectedQuizOption = null;

function selectQuizOption(index) {
    document.querySelectorAll('.quiz-option').forEach((option, i) => {
        option.classList.toggle('selected', i === index);
    });
    selectedQuizOption = index;
}

function checkQuizAnswer() {
    const correctAnswer = 2; // Индекс правильного ответа (C)
    const resultDiv = document.getElementById('quizResult');
    
    if (selectedQuizOption === null) {
        resultDiv.innerHTML = '<div class="alert alert-warning">Выберите вариант ответа!</div>';
        resultDiv.style.display = 'block';
        return;
    }
    
    if (selectedQuizOption === correctAnswer) {
        resultDiv.innerHTML = `
            <div class="alert alert-success">
                <i class="bi bi-check-circle me-2"></i>
                Правильно! Длинные случайные пароли с разными символами наиболее надежны.
            </div>
        `;
    } else {
        resultDiv.innerHTML = `
            <div class="alert alert-danger">
                <i class="bi bi-x-circle me-2"></i>
                Неправильно! Самый надежный пароль - длинный и полностью случайный.
            </div>
        `;
    }
    resultDiv.style.display = 'block';
}

// Показать ошибку
function showError(message) {
    document.getElementById('gameSection').innerHTML = `
        <div class="text-center text-danger">
            <i class="bi bi-exclamation-triangle display-4"></i>
            <p class="mt-3">${message}</p>
            <button class="btn btn-cyber mt-2" onclick="loadGameData()">
                <i class="bi bi-arrow-repeat me-2"></i>Попробовать снова
            </button>
        </div>
    `;
}

// Обновление значения при движении слайдера
document.getElementById('strengthSlider').addEventListener('input', function() {
    updateStrengthIndicator(this.value);
});

// Запуск при загрузке страницы
document.addEventListener('DOMContentLoaded', function() {
    loadGameData();
    updateStrengthIndicator(50);
});
</script>
{% endblock %}
